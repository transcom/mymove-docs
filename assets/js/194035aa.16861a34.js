"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[5215],{75931:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>s,default:()=>m,frontMatter:()=>o,metadata:()=>r,toc:()=>l});var n=a(87462),i=(a(67294),a(3905));a(8209);const o={sidebar_position:10},s="Test data generation",r={unversionedId:"backend/testing/test-data-generation",id:"backend/testing/test-data-generation",title:"Test data generation",description:"When working with or testing our system, it can be helpful to have sample data in the system that gives you good starting points for different steps in the process and/or seeing different features in action.",source:"@site/docs/backend/testing/test-data-generation.md",sourceDirName:"backend/testing",slug:"/backend/testing/test-data-generation",permalink:"/mymove-docs/docs/backend/testing/test-data-generation",draft:!1,editUrl:"https://github.com/transcom/mymove-docs/edit/main/docs/backend/testing/test-data-generation.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10},sidebar:"backendSidebar",previous:{title:"Running server tests inside a transaction",permalink:"/mymove-docs/docs/backend/testing/running-server-tests-inside-a-transaction"},next:{title:"Testing best practices",permalink:"/mymove-docs/docs/backend/testing/testing-best-practices"}},d={},l=[{value:"Scenarios and Usage",id:"scenarios-and-usage",level:2},{value:"Usage",id:"usage",level:3},{value:"Make targets",id:"make-targets",level:4},{value:"generate-test-data command",id:"generate-test-data-command",level:4},{value:"Numbered Scenarios",id:"numbered-scenarios",level:5},{value:"Sub-scenarios (devseed only, optional)",id:"sub-scenarios-devseed-only-optional",level:5},{value:"Data Generation",id:"data-generation",level:3},{value:"Updating Scenarios",id:"updating-scenarios",level:2},{value:"Adding a New Case (e2ebasic and bandwidth only)",id:"adding-a-new-case-e2ebasic-and-bandwidth-only",level:3},{value:"Adding a Sub-Scenario (devseed only)",id:"adding-a-sub-scenario-devseed-only",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"My changes are not there when running <code>generate-test-data</code>. What do I do?",id:"my-changes-are-not-there-when-running-generate-test-data-what-do-i-do",level:3},{value:"Resources",id:"resources",level:2}],u={toc:l},c="wrapper";function m(e){let{components:t,...o}=e;return(0,i.kt)(c,(0,n.Z)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"test-data-generation"},"Test data generation"),(0,i.kt)("p",null,"When working with or testing our system, it can be helpful to have sample data in the system that gives you good starting points for different steps in the process and/or seeing different features in action."),(0,i.kt)("h2",{id:"scenarios-and-usage"},"Scenarios and Usage"),(0,i.kt)("p",null,"We have data set up for various scenarios and use cases. You can find them in ",(0,i.kt)("inlineCode",{parentName:"p"},"pkg/testdatagen/scenario"),"."),(0,i.kt)("admonition",{title:"Primary use cases",type:"info"},(0,i.kt)("ul",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"devseed")," - Used to populate the local ",(0,i.kt)("inlineCode",{parentName:"li"},"dev")," database and for the databases used in ",(0,i.kt)("strong",{parentName:"li"},"Ephemeral")," environments."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"e2ebasic")," - Used by our e2e tests, either by Circle CI, or when you run those tests locally (depending on how you run them)."))),(0,i.kt)("h3",{id:"usage"},"Usage"),(0,i.kt)("p",null,"To generate the test data, you can use either ",(0,i.kt)("inlineCode",{parentName:"p"},"make")," targets that are set up to use specific sets of data, or you can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"generate-test-data")," command."),(0,i.kt)("h4",{id:"make-targets"},"Make targets"),(0,i.kt)("p",null,"We have several ",(0,i.kt)("inlineCode",{parentName:"p"},"make")," targets that will set up data for you. For example ",(0,i.kt)("inlineCode",{parentName:"p"},"make db_dev_fresh")," will start up your ",(0,i.kt)("inlineCode",{parentName:"p"},"dev")," db, clear out any existing data, and populate it with the data defined in the ",(0,i.kt)("inlineCode",{parentName:"p"},"devseed.go")," file. You can also use ",(0,i.kt)("inlineCode",{parentName:"p"},"make db_dev_e2e_populate")," which is similar, but it expects the ",(0,i.kt)("inlineCode",{parentName:"p"},"dev")," db to already be running, and it doesn't recreate the database from scratch, which can make it faster if you have already set up your db previously and don't want to start from the beginning."),(0,i.kt)("p",null,"You can also use ",(0,i.kt)("inlineCode",{parentName:"p"},"make db_e2e_up")," (or any ",(0,i.kt)("inlineCode",{parentName:"p"},"make")," targets that use the ",(0,i.kt)("inlineCode",{parentName:"p"},"db_e2e_up")," target), which instead of using the ",(0,i.kt)("inlineCode",{parentName:"p"},"dev")," db and ",(0,i.kt)("inlineCode",{parentName:"p"},"devseed.go"),", will instead populate the ",(0,i.kt)("inlineCode",{parentName:"p"},"test")," with the data defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"e2ebasic.go"),"."),(0,i.kt)("h4",{id:"generate-test-data-command"},"generate-test-data command"),(0,i.kt)("p",null,"We also have a command that can be used to customize which scenario is used and which database is populated. This is actually what is used by the ",(0,i.kt)("inlineCode",{parentName:"p"},"make")," targets described above."),(0,i.kt)("p",null,"To use it:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Run ",(0,i.kt)("inlineCode",{parentName:"li"},"make bin/generate-test-data"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"This will build the fake data generator binary."))),(0,i.kt)("li",{parentName:"ol"},"Run ",(0,i.kt)("inlineCode",{parentName:"li"},"DB_PORT=5433 bin/generate-test-data")," with the options you want:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--named-scenario=")," is used to define which scenario you want to use, e.g. ",(0,i.kt)("inlineCode",{parentName:"li"},'--named-scenario="dev_seed"')," or ",(0,i.kt)("inlineCode",{parentName:"li"},'--named-scenario="e2e_basic"'),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Note that the names here are slightly different from the file names. You can find the name of the scenario that you need by opening the file in ",(0,i.kt)("inlineCode",{parentName:"li"},"pkg/testdatagen/scenario")," that you're interested and looking near the top for something similar to this: ",(0,i.kt)("inlineCode",{parentName:"li"},'var DevSeedScenario = devSeedScenario{"dev_seed"}')," but with all the var names being different since they're defined based on the scenario they're for."))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--named-sub-scenario")," is an optional param used to define which sub-scenario you want to use in the specified named scenario. E.g. ",(0,i.kt)("inlineCode",{parentName:"li"},'--named-scenario="dev_seed" --named-sub-scenario="shipment_hhg_cancelled"')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--db-env=")," is used to define the environment you want to use for the database, e.g. ",(0,i.kt)("inlineCode",{parentName:"li"},'--db-env="development"')," or ",(0,i.kt)("inlineCode",{parentName:"li"},'--db-env="test"'))))),(0,i.kt)("p",null,"So a sample command might look like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},'DB_PORT=5433 bin/generate-test-data --named-scenario=e2e_basic --db-env="test"\n')),(0,i.kt)("h5",{id:"numbered-scenarios"},"Numbered Scenarios"),(0,i.kt)("p",null,"Some of the scenarios are numbered, so if you want to run one of those, you'll need to add another argument to your ",(0,i.kt)("inlineCode",{parentName:"p"},"generate-test-data")," call, ",(0,i.kt)("inlineCode",{parentName:"p"},"--scenario="),", where the value is a number. We technically have the following numbered scenarios:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"--scenario=1 for Award Queue Scenario 1"),(0,i.kt)("li",{parentName:"ul"},"--scenario=2 for Award Queue Scenario 2"),(0,i.kt)("li",{parentName:"ul"},"--scenario=3 for Duty Station Scenario"),(0,i.kt)("li",{parentName:"ul"},"--scenario=4 for PPM or PPM SIT Estimate Scenario (can also use Rate Engine Scenarios for Estimates)"),(0,i.kt)("li",{parentName:"ul"},"--scenario=5 for Rate Engine Scenario 1"),(0,i.kt)("li",{parentName:"ul"},"--scenario=6 for Rate Engine Scenario 2"),(0,i.kt)("li",{parentName:"ul"},"--scenario=7 for TSP test data")),(0,i.kt)("h5",{id:"sub-scenarios-devseed-only-optional"},"Sub-scenarios (devseed only, optional)"),(0,i.kt)("p",null,"A sub-scenario using the ",(0,i.kt)("inlineCode",{parentName:"p"},"--named-sub-scenario")," option is a recent addition to the ",(0,i.kt)("inlineCode",{parentName:"p"},"generate-test-data")," script. It's mainly used to run a very specific sub-scenario within a named scenario. If a sub-scenario is not specified, then the entire named scenario will run which includes the sub-scenario."),(0,i.kt)("p",null,"Currently available sub-scenarios for each main named scenarios:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"dev_seed"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"additional_ppm_users"),": creates additional ppm users for testing"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"diverted_shipments"),": creates shipments that are diverted"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"hhg_onboarding"),": creates hhg shipments for TOO/TIO onboarding"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"hhg_services_counseling"),": creates hhg shipments for Services Counseling"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"payment_request_calculations"),": creates payment requests under move code ",(0,i.kt)("inlineCode",{parentName:"li"},"PARAMS")," to show calculations for the TIO"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ppm_and_hhg"),": creates a combo ppm and hhg shipments"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ppm_office_queue"),": creates moves for the ppm office queue"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"shipment_hhg_cancelled"),": creates an hhg shipment that is in the cancelled state."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"txo_queues"),": creates moves for the TXO queues"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"misc"),": creates misc seed data (see sub-scenario for more info)")))),(0,i.kt)("h3",{id:"data-generation"},"Data Generation"),(0,i.kt)("p",null,"The scenarios use our ",(0,i.kt)("inlineCode",{parentName:"p"},"testdatagen")," functions to quickly wire up the data they need. You can find more info on using ",(0,i.kt)("inlineCode",{parentName:"p"},"testdatagen")," functions ",(0,i.kt)("a",{parentName:"p",href:"/mymove-docs/docs/backend/testing/understanding-testdatagen-functions"},"here")),(0,i.kt)("h2",{id:"updating-scenarios"},"Updating Scenarios"),(0,i.kt)("p",null,"If you want to add more data to a given scenario, or tweak it, you can edit the file of the scenario you want as needed."),(0,i.kt)("h3",{id:"adding-a-new-case-e2ebasic-and-bandwidth-only"},"Adding a New Case (e2ebasic and bandwidth only)"),(0,i.kt)("p",null,"If you are adding a new case, e.g. an un-submitted move with an HHG shipment that has multiple destination addresses, you would add a function to the file like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func createUnsubmittedHHGMoveMultipleDestinations(db *pop.Connection) {\n    /*\n    A service member with an un-submitted move that has an HHG shipment going to multiple destination addresses\n    */\n\n    email := "hhg-multple-destinations@unsubmitted"\n    uuidStr := "f08146cf-4d6b-43d5-9ca5-c8d239d37b3e"\n    loginGovUUID := uuid.Must(uuid.NewV4())\n\n    testdatagen.MakeUser(db, testdatagen.Assertions{\n        User: models.User{\n            ID:            uuid.Must(uuid.FromString(uuidStr)),\n            LoginGovUUID:  &loginGovUUID,\n            LoginGovEmail: email,\n            Active:        true,\n        },\n    })\n\n    // rest of logic for creating the move/shipment as needed\n}\n')),(0,i.kt)("p",null,"Note that we use a combo of hard-coded UUIDs (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},'"f08146cf-4d6b-43d5-9ca5-c8d239d37b3e"'),") and generated UUIDs (",(0,i.kt)("inlineCode",{parentName:"p"},"uuid.Must(uuid.NewV4())"),"). We have the hard-coded ones where it is helpful to have an ID we can easily look up. It also makes it nice so that when you refresh the database, you can still use those same IDs (e.g. reloading some pages will work and give you the fresh data)."),(0,i.kt)("p",null,"Then down in the ",(0,i.kt)("inlineCode",{parentName:"p"},"Run")," function, you`d add a call to your new function wherever seems appropriate. In our example, this would probably go well with the other onboarding data e.g."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"// Run does that data load thing\nfunc (e devSeedScenario) Run(db *pop.Connection, userUploader *uploader.UserUploader, primeUploader *uploader.PrimeUploader, routePlanner route.Planner, logger Logger) {\n    // other creation logic\n\n    // Onboarding\n    createUnsubmittedHHGMove(db)\n    createUnsubmittedHHGMoveMultipleDestinations(db)\n    createUnsubmittedMoveWithNTSAndNTSR(db)\n    createServiceMemberWithOrdersButNoMoveType(db)\n    createServiceMemberWithNoUploadedOrders(db)\n\n    // other creation logic.\n}\n")),(0,i.kt)("p",null,"Now you should be able to run the commands to populate the database and see your data."),(0,i.kt)("p",null,"An important thing to note is that the email you use in your user creation (SMs and office users), is the email used to display on the local log in page, so the better your email, the easier it is to use:\n",(0,i.kt)("img",{alt:"screenshot of local login emails",src:a(60021).Z,width:"457",height:"194"})),(0,i.kt)("p",null,"In the screenshot above, our new service member can be seen quickly and easily. If you notice though, the last email in that screenshot is ",(0,i.kt)("inlineCode",{parentName:"p"},"first.last@login.gov.test (milmove)"),". That's what happens when you don't specify the email, which makes it harder to know what that service member (or office user if in the office side) is set up with. This also happens when we accidentally use the ",(0,i.kt)("inlineCode",{parentName:"p"},"testdatagen")," functions incorrectly and they generate extra users that we don't actually want."),(0,i.kt)("h3",{id:"adding-a-sub-scenario-devseed-only"},"Adding a Sub-Scenario (devseed only)"),(0,i.kt)("p",null,"To add in a new sub-scenario:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Create a sub-scenario function in the ",(0,i.kt)("inlineCode",{parentName:"li"},"subscenarios.go")," file:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"func myNewSubScenario() func() {\n    // notice that we're returning a function here\n    // this is to create a closure function so we can use the params passed in for later in the sub-scenario list\n    return func() {\n        // code that seeds data\n    }\n}\n")),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Add new sub-scenario function to the list in the ",(0,i.kt)("inlineCode",{parentName:"li"},"Setup()")," function located in ",(0,i.kt)("inlineCode",{parentName:"li"},"devseed.go"),":")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'// Setup initializes the setup data for devseed\n// this is where the sub-scenarios are set up and stored\nfunc (e *devSeedScenario) Setup(db *pop.Connection, userUploader *uploader.UserUploader, primeUploader *uploader.PrimeUploader, logger Logger) {\n    // add the name of your sub-scenario as the key\n    // add the sub-scenario function as the value\n    e.SubScenarios = map[string]func(){\n        "my_new_sub_scenario": myNewSubScenario(),\n    }\n}\n')),(0,i.kt)("p",null,"That's it! The new sub-scenario is added to the list and can now be used by running:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'generate-test-data --named-scenario="dev_seed" --named-sub-scenario="my_new_sub_scenario" --db-env="development"\n')),(0,i.kt)("p",null,"Or by running the make cmd:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"DEVSEED_SUBSCENARIO=mySubScenario make db_dev_e2e_populate\n")),(0,i.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,i.kt)("h3",{id:"my-changes-are-not-there-when-running-generate-test-data-what-do-i-do"},"My changes are not there when running ",(0,i.kt)("inlineCode",{parentName:"h3"},"generate-test-data"),". What do I do?"),(0,i.kt)("p",null,"This is most likely because the binary file is not updated. You can regenerate the binary by running these commands in the project directory:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"rm bin/generate-test-data && make bin/generate-test-data\n")),(0,i.kt)("p",null,"Or using the go cmd directly:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'go run github.com/transcom/mymove/cmd/generate-test-data --named-scenario="dev_seed" --db-env="development" --named-sub-scenario="mySubScenario"\n')),(0,i.kt)("h2",{id:"resources"},"Resources"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/transcom/mymove#dev-db-commands"},(0,i.kt)("inlineCode",{parentName:"a"},"Dev")," DB commands")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/transcom/mymove#test-db-commands"},(0,i.kt)("inlineCode",{parentName:"a"},"Test")," DB commands")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/mymove-docs/docs/backend/testing/run-e2e-tests"},"Running e2e tests")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/mymove-docs/docs/backend/testing/understanding-testdatagen-functions"},"Testdatagen functions"))))}m.isMDXComponent=!0},60021:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/local_login_emails-e622881bec62c00d1c78e152913638aa.png"}}]);