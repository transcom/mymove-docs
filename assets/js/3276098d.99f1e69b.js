"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[5482],{13118:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>d});var n=a(87462),i=(a(67294),a(3905));a(8209);const o={},s="Factory Test Data Generation",r={unversionedId:"backend/testing/factory-test-data-generation",id:"backend/testing/factory-test-data-generation",title:"Factory Test Data Generation",description:"Prologue",source:"@site/docs/backend/testing/factory-test-data-generation.md",sourceDirName:"backend/testing",slug:"/backend/testing/factory-test-data-generation",permalink:"/mymove-docs/docs/backend/testing/factory-test-data-generation",draft:!1,editUrl:"https://github.com/transcom/mymove-docs/edit/main/docs/backend/testing/factory-test-data-generation.md",tags:[],version:"current",frontMatter:{},sidebar:"backendSidebar",previous:{title:"Understanding testdatagen functions",permalink:"/mymove-docs/docs/backend/testing/understanding-testdatagen-functions"},next:{title:"Manually run Prime API for Slice demo",permalink:"/mymove-docs/docs/backend/testing/manually-run-prime-api-for-slice-demo"}},l={},d=[{value:"Prologue",id:"prologue",level:2},{value:"Rules and Recommendations",id:"rules-and-recommendations",level:2},{value:"Current Status",id:"current-status",level:2},{value:"Why we use factory functions",id:"why-we-use-factory-functions",level:2},{value:"Basic Concepts",id:"basic-concepts",level:2},{value:"Build functions",id:"build-functions",level:3},{value:"Database",id:"database",level:3},{value:"Customizations",id:"customizations",level:3},{value:"CustomTypes",id:"customtypes",level:3},{value:"LinkOnly",id:"linkonly",level:3},{value:"Traits",id:"traits",level:3},{value:"Priority Order",id:"priority-order",level:3}],p={toc:d},m="wrapper";function u(e){let{components:t,...o}=e;return(0,i.kt)(m,(0,n.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"factory-test-data-generation"},"Factory Test Data Generation"),(0,i.kt)("h2",{id:"prologue"},"Prologue"),(0,i.kt)("p",null,"We are transitioning to a new package for test data generation. It's located at ",(0,i.kt)("inlineCode",{parentName:"p"},"pkg/factory"),". We previously used ",(0,i.kt)("inlineCode",{parentName:"p"},"pkg/testdatagen")," - so much of this document will be similar to the ",(0,i.kt)("a",{parentName:"p",href:"/mymove-docs/docs/backend/testing/understanding-testdatagen-functions"},"testdatagen version"),", but we're going to phase that one out eventually."),(0,i.kt)("p",null,"The main difference is that the massive struct of Assertions has been replaced by a list of Customizations. A ",(0,i.kt)("inlineCode",{parentName:"p"},"Customization")," is a wrapper or container for our models. They tell the factory - here are the customizations we want to make to this model.\n",(0,i.kt)("img",{alt:"Assertions are now Customizations",src:a(59136).Z,width:"606",height:"196"})),(0,i.kt)("p",null,"By packaging them in nice identical containers, we get some useful features that help us reduce confusion, catch errors early, and add new mechanisms."),(0,i.kt)("h2",{id:"rules-and-recommendations"},"Rules and Recommendations"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"NEVER nest a model within a model.")),(0,i.kt)("p",{parentName:"li"},"Put each model in its own ",(0,i.kt)("inlineCode",{parentName:"p"},"Customization")," in the list. Use the ",(0,i.kt)("inlineCode",{parentName:"p"},"CustomType")," to indicate if you want a model to be linked in a specific location. See ",(0,i.kt)("a",{parentName:"p",href:"#customizations"},"Customizations"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Use traits for commonly used patterns.")),(0,i.kt)("p",{parentName:"li"},"Don't create variants of the Build functions unless the default\nbuild function should build something that another variant would\nlike to exclude. An example is ",(0,i.kt)("inlineCode",{parentName:"p"},"BuildDutyLocation")," and\n",(0,i.kt)("inlineCode",{parentName:"p"},"BuildDutyLocationWithoutTransportationOffice")),(0,i.kt)("p",{parentName:"li"},"Where possible, create a ",(0,i.kt)("inlineCode",{parentName:"p"},"Trait")," - they are much more flexible and\nallow us to mix and match useful traits. See ",(0,i.kt)("a",{parentName:"p",href:"#traits"},"Traits"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Don't reuse your customization list.")),(0,i.kt)("p",{parentName:"li"},"The Build functions modify the customization list that is passed in. Create a trait if you want to reuse customizations.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Select the right ",(0,i.kt)("inlineCode",{parentName:"strong"},"Type")," for your ",(0,i.kt)("inlineCode",{parentName:"strong"},"Customization")),"."),(0,i.kt)("p",{parentName:"li"},"See ",(0,i.kt)("a",{parentName:"p",href:"#customtypes"},"CustomTypes"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Use LinkOnly to hook up a premade model.")),(0,i.kt)("p",{parentName:"li"},"See ",(0,i.kt)("a",{parentName:"p",href:"#linkonly"},"LinkOnly"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"If a ",(0,i.kt)("inlineCode",{parentName:"strong"},"pkg/factory/<model>_factory.go")," exists for your model, please use it.")))),(0,i.kt)("h2",{id:"current-status"},"Current Status"),(0,i.kt)("p",null,"We are transitioning to the Build functions over time. To know which ones to use, simply check the ",(0,i.kt)("inlineCode",{parentName:"p"},"pkg/factory")," folder. If a ",(0,i.kt)("inlineCode",{parentName:"p"},"<model>_factory.go")," exists for your model, please use it. Even if you are using testdatagen functions within the same test. It should work seamlessly."),(0,i.kt)("h2",{id:"why-we-use-factory-functions"},"Why we use factory functions"),(0,i.kt)("p",null,"When we unit test our code, we need a way to insert records in the database to test with. We need sample records to manipulate, update, delete, etc."),(0,i.kt)("p",null,"We could create them by using Pop to create in the DB directly. However, our records have a lot of interdependencies and constraints. Here\u2019s a subset of the constraints you\u2019d have to understand, and handle, to create a payment request:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Payment requests must link to existing service items."),(0,i.kt)("li",{parentName:"ul"},"Payment requests must link to an existing move record."),(0,i.kt)("li",{parentName:"ul"},"The move must link to an existing orders record."),(0,i.kt)("li",{parentName:"ul"},"Payment requests must use a sequence_id > 0"),(0,i.kt)("li",{parentName:"ul"},"Payment requests must have a PaymentRequestNumber\nthe list goes on\u2026")),(0,i.kt)("p",null,"So to test something as simple as approving a Payment Request, you\u2019d be writing a lot of test code just to create that Payment Request."),(0,i.kt)("p",null,"That\u2019s where ",(0,i.kt)("inlineCode",{parentName:"p"},"factory.Build")," functions come in handy. They efficiently ",(0,i.kt)("strong",{parentName:"p"},"create records")," with ",(0,i.kt)("strong",{parentName:"p"},"default values"),", while creating all the ",(0,i.kt)("strong",{parentName:"p"},"dependent records"),", and even allow you to ",(0,i.kt)("strong",{parentName:"p"},"override default values"),"."),(0,i.kt)("p",null,"It's important to note that they create ",(0,i.kt)("strong",{parentName:"p"},"records in the db"),' by default, so if you just want a model that doesn\'t need to exist in the db, you want to request a "stub" of the model. That will just be an in-memory model populated with data.'),(0,i.kt)("h2",{id:"basic-concepts"},"Basic Concepts"),(0,i.kt)("h3",{id:"build-functions"},"Build functions"),(0,i.kt)("p",null,"The factory functions are typically called ",(0,i.kt)("inlineCode",{parentName:"p"},"Build<Model>")," and take a database connection, a list of customizations and a list of traits. They return a model prepopulated with data, which is created by applying defaults, customizations and traits. I'll explain more as we go."),(0,i.kt)("p",null,"For now, know that ",(0,i.kt)("inlineCode",{parentName:"p"},"testdatagen.Make<Model>")," is being replaced by ",(0,i.kt)("inlineCode",{parentName:"p"},"factory.Build<Model>"),", the factory will return a populated model in-memory."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Example:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"testdatagen.MakeAdminUser")," \u2192 ",(0,i.kt)("inlineCode",{parentName:"li"},"factory.BuildAdminUser"))),(0,i.kt)("h3",{id:"database"},"Database"),(0,i.kt)("p",null,"Most ",(0,i.kt)("inlineCode",{parentName:"p"},"Build")," functions will take a database parameter, such as ",(0,i.kt)("inlineCode",{parentName:"p"},"suite.DB()"),"."),(0,i.kt)("p",null,"To get a stubbed return model, simply pass in ",(0,i.kt)("inlineCode",{parentName:"p"},"nil")," as your database. No records will be created."),(0,i.kt)("h3",{id:"customizations"},"Customizations"),(0,i.kt)("p",null,"As mentioned, we can pass in customizations to the factory. A customization is simply a wrapper containing the model with the fields we want modified."),(0,i.kt)("p",null,"Here's what the ",(0,i.kt)("inlineCode",{parentName:"p"},"Customization")," struct looks like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"type Customization struct {\n Model     interface{}\n Type      *CustomType\n LinkOnly  bool\n}\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"Model")," - The model containing the fields we want modified")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"Type")," - Optional param of type ",(0,i.kt)("inlineCode",{parentName:"p"},"CustomType")," that tells the factory what type of model is provided. Default is the type of the model."),(0,i.kt)("p",{parentName:"li"},"In most cases, there is no need to provide this as the factory can detect the type. However, there are a few instances where the factory needs to know how to hookup the model (like DeliveryAddress vs. PickupAddress) where the caller must provide the ",(0,i.kt)("inlineCode",{parentName:"p"},"CustomType"),". See ",(0,i.kt)("a",{parentName:"p",href:"#customtypes"},"Custom Types"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"LinkOnly")," - Bool that tells the factory to only link (and not create) this model. Default is false. See ",(0,i.kt)("a",{parentName:"p",href:"#linkonly"},"LinkOnly"),"."))),(0,i.kt)("p",null,"Since the factory will build multiple models, we pass in a list of ",(0,i.kt)("inlineCode",{parentName:"p"},"Customizations"),", not just one. Then, if your model needs another model to be created, the factory will pass on your ",(0,i.kt)("inlineCode",{parentName:"p"},"Customizations")," to the appropriate model factory."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Customization List",src:a(71448).Z,width:"300",height:"214"})),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Example:")),(0,i.kt)("p",null,"To create a ",(0,i.kt)("inlineCode",{parentName:"p"},"User")," with a specific ",(0,i.kt)("inlineCode",{parentName:"p"},"LoginGovEmail"),", we can do the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"  // Create a User with a customized email\n  user := BuildUser(suite.DB(), []Customization{\n   {\n    Model: models.User{\n     LoginGovEmail: customEmail,\n    },\n   },\n  }, nil)\n")),(0,i.kt)("p",null,"The resulting user will have defaults for all other fields, but the ",(0,i.kt)("inlineCode",{parentName:"p"},"customEmail")," will override the default ",(0,i.kt)("inlineCode",{parentName:"p"},"LoginGovEmail"),"."),(0,i.kt)("h3",{id:"customtypes"},"CustomTypes"),(0,i.kt)("p",null,"CustomTypes tell the factory where to apply these modifications. In most cases, there's really only one of each type because of the way the dependencies work."),(0,i.kt)("p",null,"If you're creating a service item, there's only one service item, service member, shipment, move etc. associated with it. So you can simply provide a ",(0,i.kt)("inlineCode",{parentName:"p"},"Move")," model, a ",(0,i.kt)("inlineCode",{parentName:"p"},"ServiceMember")," model etc, and the factory will know how to hook that in."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Example:")),(0,i.kt)("p",null,"To create an ",(0,i.kt)("inlineCode",{parentName:"p"},"AdminUser")," whose ",(0,i.kt)("inlineCode",{parentName:"p"},"User")," should have a ",(0,i.kt)("inlineCode",{parentName:"p"},"customEmail"),", just provide the ",(0,i.kt)("inlineCode",{parentName:"p"},"User"),", no need to add a ",(0,i.kt)("inlineCode",{parentName:"p"},"Type"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"  // Create an AdminUser\n  user := BuildAdminUser(suite.DB(), []Customization{\n   {\n    Model: models.User{ // \u2190 Type field not required, defaults to model type\n     LoginGovEmail: customEmail,\n    },\n   },\n  }, nil)\n")),(0,i.kt)("p",null,"In a few cases, there might be more than one. These cases are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Addresses"),(0,i.kt)("li",{parentName:"ul"},"DutyLocations"),(0,i.kt)("li",{parentName:"ul"},"Dimensions")),(0,i.kt)("p",null,"So for those, you should tell the factory where you want to hook that model up. Is it a ",(0,i.kt)("inlineCode",{parentName:"p"},"PickupAddress"),"? Or a ",(0,i.kt)("inlineCode",{parentName:"p"},"SecondaryDeliveryAddress"),"?"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"  // Create a User with a specific PickupAddress\n  user := BuildUser(suite.DB(), []Customization{\n   {\n    Model: models.Address{\n     LoginGovEmail: customEmail,\n    },\n    Type: Addresses.PickupAddress, // \u2190 Type field required\n   },\n  }, nil)\n")),(0,i.kt)("h3",{id:"linkonly"},"LinkOnly"),(0,i.kt)("p",null,"To supply a premade model, just pass in a customization with the premade model, and set ",(0,i.kt)("inlineCode",{parentName:"p"},"LinkOnly")," to true. This tells the factory to only link (and not create) this model."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Example:")),(0,i.kt)("p",null,"Say you have a user and you want to create an associated ",(0,i.kt)("inlineCode",{parentName:"p"},"AdminUser"),". You call ",(0,i.kt)("inlineCode",{parentName:"p"},"BuildAdminUser")," but provide a link-only ",(0,i.kt)("inlineCode",{parentName:"p"},"User"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"\n  adminUser := BuildAdminUser(suite.DB(), []Customization{\n   {\n    Model:    user,\n    LinkOnly: true,\n   },\n  }, nil)\n")),(0,i.kt)("h3",{id:"traits"},"Traits"),(0,i.kt)("p",null,"At times, there are common repeated customizations."),(0,i.kt)("p",null,"For e.g. it's common to want the ",(0,i.kt)("inlineCode",{parentName:"p"},"AdminUser.Email")," to match the ",(0,i.kt)("inlineCode",{parentName:"p"},"User.LoginGovEmail"),". Rather than reconstructing these each time, you can create a ",(0,i.kt)("inlineCode",{parentName:"p"},"Trait")," functions that combines both ",(0,i.kt)("inlineCode",{parentName:"p"},"Customizations"),"."),(0,i.kt)("p",null,"These can be flexibly applied with other traits and customizations in priority order. You could pass in multiple traits like ",(0,i.kt)("inlineCode",{parentName:"p"},"GetTraitActiveUser")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"GetTraitNavy"),"."),(0,i.kt)("p",null,"The traits are applied in ",(0,i.kt)("a",{parentName:"p",href:"#priority-order"},"Priority Order"),"."),(0,i.kt)("p",null,"The trait functions take no parameters and return a list of customizations. Anyone can define them, either in their own test code or in the factory code, if generally useful."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Example:")),(0,i.kt)("p",null,"To create a trait that sets both ",(0,i.kt)("inlineCode",{parentName:"p"},"AdminUser.Email")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"User.LoginGovEmail")," to the same value and use a random string to ensure uniqueness:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},'// GetTraitAdminUserEmail sets unique matching emails\nfunc GetTraitAdminUserEmail() []Customization {\n // There\'s a uniqueness constraint on admin user emails so add randomness\n email := strings.ToLower(fmt.Sprintf("email_%s@example.com", makeRandomString(5)))\n return []Customization{\n  {\n    Model: models.User{\n      LoginGovEmail: email,\n    },\n  },\n  {\n    Model: models.AdminUser{\n      Email: email,\n    },\n  },\n }\n}\n')),(0,i.kt)("p",null,"To use the trait:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"  // Create AdminUser with correct emails\n  adminUser := BuildAdminUser(suite.DB(), []Customization{\n   {\n      Model: models.User{\n        LoginGovUUID: uuid,\n      },\n   },\n  }, []Trait{\n    GetTraitAdminUserEmail, // \u2190 Trait added\n  })\n")),(0,i.kt)("h3",{id:"priority-order"},"Priority Order"),(0,i.kt)("p",null,"You might be wondering what gets priority - ",(0,i.kt)("inlineCode",{parentName:"p"},"Customizations")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"Traits"),"."),(0,i.kt)("p",null,"Essentially we start creating the model with the defaults, override those with traits, and override those with customizations. This means the user passed-in customizations have the highest priority."),(0,i.kt)("p",null,"Priority order is as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Customizations")," passed in by the user get the highest priority."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Traits")," get second priority, with earlier traits in the list overriding later traits."),(0,i.kt)("li",{parentName:"ul"},"Default values get last priority.")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Priority Order",src:a(68445).Z,width:"1000",height:"309"})),(0,i.kt)("p",null,"Note that the factory applies priority on a field-by-field basis. So if, in the above image, you didn't override ",(0,i.kt)("inlineCode",{parentName:"p"},"User.Email")," in either the customization or traits, then the return model will contain the default ",(0,i.kt)("inlineCode",{parentName:"p"},"User.Email"),"."),(0,i.kt)("p",null,"The factory will populate all fields that are not overriden, with factory defaults."))}u.isMDXComponent=!0},71448:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/customization-list-e8d028c1714194007854565112c133ce.jpg"},59136:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/old-to-new-7303c3ebf4d767cb197617349bc22901.jpg"},68445:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/priority-d3932fff4c2582e9fcf0f415858d836b.jpg"}}]);