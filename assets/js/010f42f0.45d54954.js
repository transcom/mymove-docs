"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[2132],{48332:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var i=n(45072),a=(n(11504),n(95788));n(10880);const r={sidebar_position:8},o="Running integration tests with routing middleware enabled",s={unversionedId:"backend/testing/running-integration-tests-with-routing-middleware-enabled",id:"backend/testing/running-integration-tests-with-routing-middleware-enabled",title:"Running integration tests with routing middleware enabled",description:"Sometimes it will be necessary to write server integration tests with routing middleware enabled. For example, we may want to test calling an API endpoint with an unauthorized user, and ensure that we receive a 403 response. Here's how to go about it.",source:"@site/docs/backend/testing/running-integration-tests-with-routing-middleware-enabled.md",sourceDirName:"backend/testing",slug:"/backend/testing/running-integration-tests-with-routing-middleware-enabled",permalink:"/mymove-docs/docs/backend/testing/running-integration-tests-with-routing-middleware-enabled",draft:!1,editUrl:"https://github.com/transcom/mymove-docs/edit/main/docs/backend/testing/running-integration-tests-with-routing-middleware-enabled.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8},sidebar:"backendSidebar",previous:{title:"Interacting with the database in Go server tests",permalink:"/mymove-docs/docs/backend/testing/interacting-with-the-db-in-go-server-tests"},next:{title:"Running server tests inside a transaction",permalink:"/mymove-docs/docs/backend/testing/running-server-tests-inside-a-transaction"}},l={},d=[{value:"Test name and location",id:"test-name-and-location",level:2},{value:"Test structure",id:"test-structure",level:2},{value:"Endpoint",id:"endpoint",level:3},{value:"The request body",id:"the-request-body",level:3},{value:"The request",id:"the-request",level:3},{value:"The response",id:"the-response",level:3}],p={toc:d},g="wrapper";function u(e){let{components:t,...n}=e;return(0,a.yg)(g,(0,i.c)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.yg)("h1",{id:"running-integration-tests-with-routing-middleware-enabled"},"Running integration tests with routing middleware enabled"),(0,a.yg)("p",null,"Sometimes it will be necessary to write server integration tests with routing middleware enabled. For example, we may want to test calling an API endpoint with an unauthorized user, and ensure that we receive a 403 response. Here's how to go about it."),(0,a.yg)("h2",{id:"test-name-and-location"},"Test name and location"),(0,a.yg)("p",null,"Your test will live in ",(0,a.yg)("inlineCode",{parentName:"p"},"pkg/handlers/routing"),", in a subdirectory corresponding to the API you're testing, ",(0,a.yg)("inlineCode",{parentName:"p"},"{api_name}api_test"),". Tests of the ",(0,a.yg)("inlineCode",{parentName:"p"},"internal")," API live in ",(0,a.yg)("inlineCode",{parentName:"p"},"pkg/handlers/routing/internalapi_test"),"."),(0,a.yg)("p",null,"The name of the test file should correspond to the name of the file that contains the handler that the endpoint calls, ",(0,a.yg)("inlineCode",{parentName:"p"},"{handler_file_name}_test.go"),". ",(0,a.yg)("inlineCode",{parentName:"p"},"pkg/handlers/internalapi/ppm_shipment.go")," would have a corresponding test file in ",(0,a.yg)("inlineCode",{parentName:"p"},"pkg/handlers/routing/internalapi_test/ppm_shipment_test.go"),"."),(0,a.yg)("p",null,"Generally, the test name and location should be\n",(0,a.yg)("inlineCode",{parentName:"p"},"pkg/handlers/routing/{api_name}api_test/{handler_file_name}_test.go")),(0,a.yg)("h2",{id:"test-structure"},"Test structure"),(0,a.yg)("p",null,"In general, here's how to set up the file created above."),(0,a.yg)("p",null,"Include the test as part of the ",(0,a.yg)("inlineCode",{parentName:"p"},"{api_name}api_test")," package, and any imports, as usual."),(0,a.yg)("p",null,"For each request type, write a function whose receiver is the API's test suite. For example, tests of updating a pro-gear weight ticket in the internal API's suite would look like:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},"func (suite *InternalAPISuite) TestUpdateProgearWeightTicket() {\n  ...\n}\n")),(0,a.yg)("p",null,"For each test, call ",(0,a.yg)("inlineCode",{parentName:"p"},"Run")," on the suite, with a description of the test, and the test function."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},'  suite.Run("Unauthorized progear weight ticket update by another service member", func() { ... })\n')),(0,a.yg)("p",null,"The body of the test function will likely contain some data set up -- using factories to build a pro-gear weight ticket and service member, for example -- which we can use to build the endpoint, body, and request, and get the response."),(0,a.yg)("h3",{id:"endpoint"},"Endpoint"),(0,a.yg)("p",null,"Build the endpoint from the corresponding Swagger definition. For example, the ",(0,a.yg)("inlineCode",{parentName:"p"},"swagger-def/internal.yaml")," defines the update path for pro-gear weight tickets as"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},"/ppm-shipments/{ppmShipmentId}/pro-gear-weight-tickets/{proGearWeightTicketId}\n\n")),(0,a.yg)("p",null,"Build the endpoint path, for example, assuming the ",(0,a.yg)("inlineCode",{parentName:"p"},"ppmShipment")," and ",(0,a.yg)("inlineCode",{parentName:"p"},"proGearWeightTicket")," are created,"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},'endpointPath := fmt.Sprintf("/internal/ppm-shipments/%s/pro-gear-weight-tickets/%s", ppmShipment.ID.String(), progearWeightTicket.ID.String())\n')),(0,a.yg)("p",null,"Be sure that the first path segment(s) correspond to the appropriate API:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},"Customer/internal -> ",(0,a.yg)("inlineCode",{parentName:"li"},"/internal")),(0,a.yg)("li",{parentName:"ul"},"GHC/office -> ",(0,a.yg)("inlineCode",{parentName:"li"},"/ghc/v1")),(0,a.yg)("li",{parentName:"ul"},"Prime -> ",(0,a.yg)("inlineCode",{parentName:"li"},"/prime/v1")),(0,a.yg)("li",{parentName:"ul"},"Admin -> ",(0,a.yg)("inlineCode",{parentName:"li"},"/admin/v1"))),(0,a.yg)("p",null,"These prefixes are not typically included in other tests since they do not make API requests directly."),(0,a.yg)("h3",{id:"the-request-body"},"The request body"),(0,a.yg)("p",null,"Swagger generates types that define the shape a request body should take, and we can leverage those types in writing tests."),(0,a.yg)("p",null,"For our example, our request body type is ",(0,a.yg)("inlineCode",{parentName:"p"},"internalmessages.UpdateProGearWeightTicket"),", which Swagger generates for us in ",(0,a.yg)("inlineCode",{parentName:"p"},"pkg/gen/internalmessages/update_pro_gear_weight_ticket.go"),"."),(0,a.yg)("p",null,"To build out the request body, we create an object of this type, marshal it to JSON, check for errors, then cast it to a buffer using ",(0,a.yg)("inlineCode",{parentName:"p"},"bytes.NewBuffer"),"."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},'body := &internalmessages.UpdateProGearWeightTicket{\n  Description:      handlers.FmtString("My cool stuff"),\n  HasWeightTickets: true,\n  Weight:           handlers.FmtInt64(4000),\n  BelongsToSelf:    true,\n}\n\njsonBody, err := json.Marshal(body)\n\nsuite.FatalNoError(err)\n\nbodyBuffer := bytes.NewBuffer(jsonBody)\n')),(0,a.yg)("h3",{id:"the-request"},"The request"),(0,a.yg)("p",null,"Now we can build the request from the endpoint and body. Requests are available from the ",(0,a.yg)("inlineCode",{parentName:"p"},"BaseRoutingSuite")," with and without authentication for each app:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"NewAdminRequest()")," and ",(0,a.yg)("inlineCode",{parentName:"li"},"NewAuthenticatedAdminRequest()")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"NewMilRequest()")," and ",(0,a.yg)("inlineCode",{parentName:"li"},"NewAuthenticatedMilRequest()")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"NewOfficeRequest()")," and ",(0,a.yg)("inlineCode",{parentName:"li"},"NewAuthenticatedOfficeRequest()")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"NewPrimeRequest()")," and ",(0,a.yg)("inlineCode",{parentName:"li"},"NewAuthenticatedPrimeRequest()"))),(0,a.yg)("p",null,"Since our request is hitting the customer API with authentication, we'll use ",(0,a.yg)("inlineCode",{parentName:"p"},"NewAuthenticatedMilRequest()"),", and a ",(0,a.yg)("inlineCode",{parentName:"p"},"PATCH")," method."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},'req := suite.NewAuthenticatedMilRequest("PATCH", endpointPath, bodyBuffer, wrongUser)\n')),(0,a.yg)("p",null,"Since this is a ",(0,a.yg)("inlineCode",{parentName:"p"},"PATCH")," request and we ",(0,a.yg)("a",{parentName:"p",href:"https://transcom.github.io/mymove-docs/docs/backend/guides/use-optimistic-locking"},"use optimistic locking"),", we will also need to include the ",(0,a.yg)("inlineCode",{parentName:"p"},"If-Match")," header. We will also set the ",(0,a.yg)("inlineCode",{parentName:"p"},"Content-Type")," header."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},'req.Header.Set("Content-Type", "application/json")\nreq.Header.Set("If-Match", etag.GenerateEtag(progearWeightTicket.UpdatedAt))\n')),(0,a.yg)("p",null,"Note: reference ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/transcom/mymove/blob/56590a3b462bc5709be4d5f93e9000188388329a/pkg/handlers/routing/internalapi_test/orders_test.go#L16"},"orders_test.go")," for an example of how to upload a file as part of the request body, should you need to."),(0,a.yg)("h3",{id:"the-response"},"The response"),(0,a.yg)("p",null,"Set up the response recorder and serve HTTP, then check that the response equals the expectation."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},"rr := httptest.NewRecorder()\nsuite.SetupSiteHandler().ServeHTTP(rr, req)\n\nsuite.Equal(http.StatusNotFound, rr.Code)\n")),(0,a.yg)("p",null,"(Note that this returns a ",(0,a.yg)("inlineCode",{parentName:"p"},"StatusNotFound")," rather than a ",(0,a.yg)("inlineCode",{parentName:"p"},"StatusForbidden"),", which ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/transcom/mymove/pull/10938/files#r1240473787"},"is preferred when the wrong user makes a request"),".)"))}u.isMDXComponent=!0}}]);