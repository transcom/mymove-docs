"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[7379],{42192:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var i=a(87462),n=(a(67294),a(3905));a(8209);const o={title:"0040 Add Role-Based Authorization",description:"Decision outcome: Implement Role-Based Access Control in Middleware\n"},r="Add Role-Based Authorization",s={unversionedId:"adrs/role-base-authorization",id:"adrs/role-base-authorization",title:"0040 Add Role-Based Authorization",description:"Decision outcome: Implement Role-Based Access Control in Middleware\n",source:"@site/docs/adrs/0040-role-base-authorization.md",sourceDirName:"adrs",slug:"/adrs/role-base-authorization",permalink:"/mymove-docs/docs/adrs/role-base-authorization",draft:!1,editUrl:"https://github.com/transcom/mymove-docs/edit/main/docs/adrs/0040-role-base-authorization.md",tags:[],version:"current",sidebarPosition:40,frontMatter:{title:"0040 Add Role-Based Authorization",description:"Decision outcome: Implement Role-Based Access Control in Middleware\n"},sidebar:"adrsSidebar",previous:{title:"0039 Use React Lazy for code splitting",permalink:"/mymove-docs/docs/adrs/react-lazy-and-code-splitting"},next:{title:"0041 Front End Form Library",permalink:"/mymove-docs/docs/adrs/front-end-form-library"}},l={},d=[{value:"Considered Alternatives",id:"considered-alternatives",level:2},{value:"Decision Outcome",id:"decision-outcome",level:2},{value:"Pros and Cons of the Alternatives",id:"pros-and-cons-of-the-alternatives",level:2},{value:"<em>Implement Role-Based Access Control in Middleware</em>",id:"implement-role-based-access-control-in-middleware",level:3},{value:"<em>Use a Third-Party RBAC Library</em>",id:"use-a-third-party-rbac-library",level:3},{value:"<em>Use our existing system to prevent unauthorized data access</em>",id:"use-our-existing-system-to-prevent-unauthorized-data-access",level:3},{value:"<em>Create an Enforcer Object</em>",id:"create-an-enforcer-object",level:3}],c={toc:d},m="wrapper";function p(e){let{components:t,...a}=e;return(0,n.kt)(m,(0,i.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"add-role-based-authorization"},"Add Role-Based Authorization"),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"NOTE:")," This ADR updates and supersedes ",(0,n.kt)("a",{parentName:"p",href:"/mymove-docs/docs/adrs/model-authorization-and-handler-design"},"ADR0024 Model Authorization and Handler Design"),".\n."),(0,n.kt)("p",null,"As the MilMove system takes on more types of users (including TOOs, TIOs, and\nthe GHC prime contractor), it is important to ensure that only the correct users\nare able to access each API endpoint. For example, an office user should be able to\nindex a list of moves, but a service member should not; they should only be able\nto view their own move. Currently, permissions are handled by code in the models package\nthat checks if the current user is able to access data at the time it is accessed in a\nhandler or service object. Having these checks baked into the model layer makes it difficult\nto reuse functionality in different context and also hard to see what checks are being done in\na handler or service object."),(0,n.kt)("p",null,"We want to move to a more structured role-based system, ideally one that allows us to declare\nwhat roles can access an endpoints in the same place we define that end point: the swaggerfile."),(0,n.kt)("p",null,"There will need to be additional checks throughout the system to ensure that users are able to, for example, only see their own data. But having a role-based system in place will make it easier for that code to assume that a user has certain attributes that it can then use to make such determinations."),(0,n.kt)("h2",{id:"considered-alternatives"},"Considered Alternatives"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("strong",{parentName:"p"},"Implement Role-Based Access Control in Middleware")),(0,n.kt)("p",{parentName:"li"},"  Swagger yaml files include a new \u2018roles\u2019 tag on each endpoint,\nindicating the list of roles that can access the endpoint.\nThe ",(0,n.kt)("inlineCode",{parentName:"p"},"UserAuthMiddleware")," is edited to compare this list with the roles the user has\n(by checking the session)."),(0,n.kt)("p",{parentName:"li"},"  We expect that there will be database changes made to allow for there to be a many-to-many relationship between users and roles."),(0,n.kt)("p",{parentName:"li"},"  There is a ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/transcom/mymove/pull/2824/files"},"prototype")," of this approach.")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("strong",{parentName:"p"},"Use a Third-Party RBAC Library")),(0,n.kt)("p",{parentName:"li"},"  We move to using an existing third-party library, specifically\n",(0,n.kt)("a",{parentName:"p",href:"https://github.com/casbin/casbin"},"casbin"),"."),(0,n.kt)("p",{parentName:"li"},"  Casbin requires a list of associations, which should include information of two types:"),(0,n.kt)("ol",{parentName:"li"},(0,n.kt)("li",{parentName:"ol"},"Which users are assigned to each role."),(0,n.kt)("li",{parentName:"ol"},"Which endpoints are accessible by each role."))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("strong",{parentName:"p"},"Use our existing system to prevent unauthorized data access")),(0,n.kt)("p",{parentName:"li"},"  The MilMove system currently has checks in place to prevent unauthorized data access.\nFor example, consider a Service Member accessing their PPM. The handler\ncurrently fetches the PPM based on ID, and then checks whether the SM associated\nwith that PPM is indeed the one making the request. An error is returned if not.\nNote that this process takes only one database call."),(0,n.kt)("p",{parentName:"li"},"  We can continue using this pattern as we expand the MilMove system.")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("strong",{parentName:"p"},"Create an Enforcer Object")),(0,n.kt)("p",{parentName:"li"},"This approach involves writing code to encapsulate the authorization logic and explicitly invoking it within handlers or service objects as needed. It could be seen as taking our existing system and just extracting the authorization checks into functions outside the models."),(0,n.kt)("p",{parentName:"li"},"The name for this object comes from what similar objects are called within casbin."))),(0,n.kt)("h2",{id:"decision-outcome"},"Decision Outcome"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Chosen Alternative: ",(0,n.kt)("strong",{parentName:"li"},"Implement Role-Based Access Control in Middleware")),(0,n.kt)("li",{parentName:"ul"},"The main motivators of this decision are:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"It allows us to easily audit which endpoints are accessible by which roles by examining the API descriptions in the swaggerfile."),(0,n.kt)("li",{parentName:"ul"},"Having the role check in a middleware makes it less likely that an authorization check is missed."),(0,n.kt)("li",{parentName:"ul"},"We have completed spikes that show that this approach is doable with a minimal amount of additional work.")))),(0,n.kt)("h2",{id:"pros-and-cons-of-the-alternatives"},"Pros and Cons of the Alternatives"),(0,n.kt)("h3",{id:"implement-role-based-access-control-in-middleware"},(0,n.kt)("em",{parentName:"h3"},"Implement Role-Based Access Control in Middleware")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"+")," Role/Endpoint associations live in Swagger yaml file, which is easy to read/modify"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"+")," Flexible to addition of new role types"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Requires some rework of database to represent roles"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Not able to express row-level access rules")),(0,n.kt)("h3",{id:"use-a-third-party-rbac-library"},(0,n.kt)("em",{parentName:"h3"},"Use a Third-Party RBAC Library")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"+")," 3rd party libraries are more tested and receive more frequent updates"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"+")," Able to express row-level access rules"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"+")," Flexible to addition of new role types"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Casbin has poor documentation"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Is optimized for defining rules without code changes (not a goal for our project)"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Unclear how to produce raw list of endpoint/role and role/user pairings for Casbin"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Casbin doesn't scale well, according to community members")),(0,n.kt)("h3",{id:"use-our-existing-system-to-prevent-unauthorized-data-access"},(0,n.kt)("em",{parentName:"h3"},"Use our existing system to prevent unauthorized data access")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"+")," Requires no immediate changes to existing code or developer training"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"+")," Able to express row-level access rules"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Authorization in models is not visible from handlers"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," It isn't possible to check for a permission outside attempting to load data"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Model code requires arguments for authorization that doesn't make sense in all contexts"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Adding new roles requires considerable code and database schema changes")),(0,n.kt)("h3",{id:"create-an-enforcer-object"},(0,n.kt)("em",{parentName:"h3"},"Create an Enforcer Object")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"+")," Allows for a place to put finer-grained access controls"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-")," Requires explicit use in every handler"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"-"))))}p.isMDXComponent=!0}}]);