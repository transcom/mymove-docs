<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-backend/setup/database-migrations">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">How to Migrate the Database | MilMove Developer Portal</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://transcom.github.io/mymove-docs/docs/backend/setup/database-migrations"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="How to Migrate the Database | MilMove Developer Portal"><meta data-rh="true" name="description" content="If you need to change the database schema, you&#x27;ll need to write a migration. These are the general steps you&#x27;ll need to follow:"><meta data-rh="true" property="og:description" content="If you need to change the database schema, you&#x27;ll need to write a migration. These are the general steps you&#x27;ll need to follow:"><link data-rh="true" rel="icon" href="/mymove-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://transcom.github.io/mymove-docs/docs/backend/setup/database-migrations"><link data-rh="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/backend/setup/database-migrations" hreflang="en"><link data-rh="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/backend/setup/database-migrations" hreflang="x-default"><link rel="stylesheet" href="/mymove-docs/assets/css/styles.65849403.css">
<link rel="preload" href="/mymove-docs/assets/js/runtime~main.2d8cf14e.js" as="script">
<link rel="preload" href="/mymove-docs/assets/js/main.72cd5155.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mymove-docs/"><div class="navbar__logo"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">MilMove Documentation</b></a><a class="navbar__item navbar__link" href="/mymove-docs/docs/about/">About</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/adrs">ADRs</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/frontend">Frontend</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/mymove-docs/docs/backend">Backend</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/integrations">Integrations</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/api">API</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/tools">Tools</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/help/index">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">mymove<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/mymove-docs/docs/backend">MilMove Backend</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mymove-docs/docs/backend/testing/acceptance-testing-syncada-edi-invoicing">Testing</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mymove-docs/docs/backend/guides/service-objects/overview">Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/mymove-docs/docs/backend/setup/configure-postico-or-tableplus-to-connect-to-mymove-db">Setup</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/setup/configure-postico-or-tableplus-to-connect-to-mymove-db">Configure Postico or TablePlus to connect to mymove DB</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/setup/common-errors-and-solutions">Common Errors and Solutions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/setup/backup-and-restore-dev-database">How To Backup and Restore the Development Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mymove-docs/docs/backend/setup/database-migrations">How to Migrate the Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/setup/run-pre-commit-hooks">Run pre-commit hooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/setup/using-eagerpreload-in-pop">Using EagerPreload in Pop</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/mymove-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Setup</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">How to Migrate the Database</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>How to Migrate the Database</h1><p>If you need to change the database schema, you&#x27;ll need to write a migration. These are the general steps you&#x27;ll need to follow:</p><ol><li><a href="#creating-Migrations">Generate a new migration file</a></li><li><a href="#writing-migrations">Add the new SQL to the generated file</a></li><li><a href="#setup">Set up your database</a></li><li><a href="#running-migrations">Run the migrations</a></li><li><a href="#update-migrations-locally">Update migrations locally</a></li><li>Test your new migration</li></ol><p>After your testing, if you find that you need to change your migration, you&#x27;ll need to reset your DB (<code>make db_&lt;env&gt;_reset</code>) and rerun the migrations to make sure your updates are reflected in the local DB instance. </p><p>Once you have completed your testing, push your changes up for review! You&#x27;ll need a review from someone in the DB reviewers group, and if it&#x27;s a secure migration, you&#x27;ll need to test your changes on Experimental. Read <a href="https://dp3.atlassian.net/l/c/5G1P0dX0" target="_blank" rel="noopener noreferrer">these instructions</a> to learn about deploying to Experimental.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="understanding-migrations">Understanding Migrations<a href="#understanding-migrations" class="hash-link" aria-label="Direct link to Understanding Migrations" title="Direct link to Understanding Migrations">​</a></h2><p>Database migrations are SQL scripts that modify the state of the database (ie, the database schema). They are how we add and modify tables, columns, indexes, comments, and other aspects of our database. We also have migrations that insert constant data into our tables so that we will always have access to certain data values/records. </p><p>These scripts are not living files like the rest of our source code. You can think of them as snapshots of the state of the DB over time. <strong>In general, we should not update old migration files.</strong> If you need to change something added in the past, create a new migration that overrides the old one instead. </p><p>The MilMove migration files are located in the <code>migrations/app</code> directory. There are two subdirectories:</p><ul><li><code>/schema</code>: the migrations that define the schema for our DB. This is most likely where you&#x27;ll be working.</li><li><code>/secure</code>: these migrations are adding or modifying sensitive data in the DB. CAC credentials, for example, will be in this directory. You will need to follow special instructions if you are working with these files. </li></ul><p>The <code>migrations_manifest.txt</code> file contains a list of all of the migrations in both <code>schema</code> and <code>secure</code>. This file is what tells the database which scripts to run when we call the <code>migrate</code> command. It will be updated automatically as part of the process of generating a new migration - you will likely never need to make manual updates to this file.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup<a href="#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup">​</a></h2><p>Before running any of the commands listed here locally, make sure the DB is up and running:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">make db_dev_run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and/or</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">make db_test_run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To reset the database, use:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">make db_dev_reset</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">make db_test_reset</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>These commands will tear down the existing instance of the database and rebuild a new version. This is useful when you&#x27;re testing new migrations and you don&#x27;t want to go through the pain of reverting and reapplying a migration whenever you make an update. Instead, you can start fresh and apply the updated migrations from scratch.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-migrations">Creating Migrations<a href="#creating-migrations" class="hash-link" aria-label="Direct link to Creating Migrations" title="Direct link to Creating Migrations">​</a></h2><p>To generate a new migration file, use: </p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">milmove gen migration -n &lt;migration_name&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>where <code>&lt;migration_name&gt;</code> is a brief description of the action being performed. The name must be in snake case, such as <code>add_status_to_moves</code>. This will create a placeholder migration and add it to the manifest.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="milmove-gen-command"><code>milmove gen</code> command<a href="#milmove-gen-command" class="hash-link" aria-label="Direct link to milmove-gen-command" title="Direct link to milmove-gen-command">​</a></h3><p>There are other subcommands for <code>milmove gen</code> that you can leverage to generate models and migrations. To see a list of available subcommands,
run <code>milmove gen</code>. To run a specific subcommand, use the syntax <code>milmove gen &lt;subcommand&gt;</code>. The subcommands include:</p><ul><li><code>migration</code>: creates a generic migration for you to populate. <strong>This is most likely the one you want to use.</strong></li><li><code>disable-user-migration</code>: creates a migration for disabling a user given their e-mail address.</li><li><code>duty-stations-migration</code>: creates a migration to update duty stations given a CSV of duty station data.</li><li><code>certs-migration</code>: creates a migration to add a certificate for access to electronic orders and the prime api.</li></ul><p><em>NOTE: We <strong>don&#x27;t</strong> use <code>down-migrations</code> to revert changes to the schema; any problems are to be fixed by a follow-up migration.</em></p><p>You can also run <code>update-migrations-manifest</code> to update the <code>migrations_manifest.txt</code> file. This is only necessary if you manually create a new migration file instead of using <code>milmove gen migration</code> to generate a new file. There&#x27;s really no reason to manually create a file; just use <code>milmove gen</code>. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="writing-migrations">Writing migrations<a href="#writing-migrations" class="hash-link" aria-label="Direct link to Writing migrations" title="Direct link to Writing migrations">​</a></h3><p>When you are writing the code for your new migration, there are a few things you should keep in mind:</p><ul><li><p><strong>Please use SQL.</strong> There are old instructions about using <code>fizz</code> to write migrations instead - <strong>do not do this.</strong></p></li><li><p>You must manually define all primary keys and indexes. There is nothing in Pop or SQL that will automatically make these for you. Failure to do so may break tools or lead to inefficiencies in the API implementations.</p></li><li><p><a href="#why-we-avoid-uuid_generate_v4">Avoid using <code>uuid_generate_v4()</code></a>. Instead, please generate a valid UUID4 value using one of the following methods:</p><ul><li><p>Get a valid UUID4 from <a href="https://www.uuidgenerator.net/" target="_blank" rel="noopener noreferrer">the Online UUID Generator</a></p></li><li><p>Use <code>python -c &#x27;import uuid; print(str(uuid.uuid4()))&#x27;</code></p></li><li><p>Use <code>brew install uuidgen; uuidgen</code></p><p>Never use the same UUID more than once. It should be unique across the whole database. </p></li></ul></li><li><p>Follow best practices for ensuring <a href="#zero-downtime-migrations">Zero-Downtime Deploys</a>. Your migrations should create a database state that is compatible with the current version of the application code <em>and</em> the new version of the application code.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-a-new-table">Adding a new table<a href="#adding-a-new-table" class="hash-link" aria-label="Direct link to Adding a new table" title="Direct link to Adding a new table">​</a></h3><p>This section covers what it&#x27;s like to add a new table, though some information is helpful when editing existing
tables/models as well.</p><p>For the examples in this section, we&#x27;ll be adding a new model called <code>Pet</code>, with a corresponding table called <code>pets</code>.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Table Name vs Model Name</div><div class="admonitionContent_S0QG"><p>Notice how the model name is singular, while the table name is pluralized. This is a convention of <code>Pop</code>, our ORM.
See the <a href="https://www.gobuffalo.io/en/docs/db/getting-started" target="_blank" rel="noopener noreferrer">conventions Pop follows</a> for more info.</p></div></div><ol><li><p><a href="#creating-migrations">Generate a new migration file</a>.</p></li><li><p>Open the generated SQL file and add the logic to create your table. When creating the SQL you may write the
migration like this:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TYPE</span><span class="token plain"> pet_type </span><span class="token keyword" style="color:#c5a5c5">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">enum</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&#x27;CAT&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&#x27;DOG&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&#x27;FISH&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&#x27;GUINEA PIG&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&#x27;HAMSTER&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&#x27;OTHER&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&#x27;RAT&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&#x27;SNAKE&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&#x27;TURTLE&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> pets</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    id uuid </span><span class="token keyword" style="color:#c5a5c5">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">KEY</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    created_at </span><span class="token keyword" style="color:#c5a5c5">timestamp</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    updated_at </span><span class="token keyword" style="color:#c5a5c5">timestamp</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> pet_type </span><span class="token operator" style="color:#d7deea">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    name </span><span class="token keyword" style="color:#c5a5c5">text</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    birthday </span><span class="token keyword" style="color:#c5a5c5">date</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    gotcha_day </span><span class="token keyword" style="color:#c5a5c5">date</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    bio </span><span class="token keyword" style="color:#c5a5c5">text</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    weight </span><span class="token keyword" style="color:#c5a5c5">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> pets </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;Store pets and their details.&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> pets</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;The type of pet this is. There are child models for certain types to hold more information specific to that type.&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> pets</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">name </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;The official name of a pet...nicknames might need their own table...&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> pets</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">birthday </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;Date the pet was born.&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> pets</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">gotcha_day </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;Date the pet was adopted. May be same as birthday.&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> pets</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">bio </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;Big text field for owners to tell you everything about their pet.&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> pets</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">weight </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;Current weight of the pet, or at least what they weighed the last time they let you weigh them.&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> Some things to note:</p><ol><li>The SQL keywords don&#x27;t need to be capitalized, but it can be nice to differentiate some of them from certain
things like the field names or types.</li><li>We create a <code>pet_type</code> <code>enum</code> to state the specific values that are allowed for our <code>pets.type</code> field. We&#x27;ll see
in a bit how this maps to custom types in the model. </li><li>We want to add comments for the table itself and every column other than the <code>id</code>, <code>created_at</code>, and <code>updated_at</code>
fields. This makes it easier for future folks to understand what the columns were meant for.</li><li>You might see some migrations use <code>varchar</code> instead of <code>text</code>. It&#x27;s the same thing in the end, see
<a href="https://www.postgresqltutorial.com/postgresql-char-varchar-text/" target="_blank" rel="noopener noreferrer">Postgresql Character Types</a> for more info.</li></ol></li><li><p>Now you can create a new file in <code>pkg/models/</code> named after your new model. So for this, we&#x27;ll have a new file
<code>pkg/models/pet.go</code> that will look something like this:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockTitle_Ktv7">pkg/models/pet.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">package</span><span class="token plain"> models</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&quot;github.com/gofrs/uuid&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&quot;github.com/transcom/mymove/pkg/unit&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> PetType </span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">// PetTypeCat captures the enum value &quot;CAT&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetTypeCat PetType </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;CAT&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">// PetTypeDog captures the enum value &quot;DOG&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetTypeDog PetType </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;DOG&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">// PetTypeFish captures the enum value &quot;FISH&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetTypeFish PetType </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;FISH&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">// PetTypeGuineaPig captures the enum value &quot;GUINEA_PIG&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetTypeGuineaPig PetType </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;GUINEA_PIG&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">// PetTypeHamster captures the enum value &quot;HAMSTER&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetTypeHamster PetType </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;HAMSTER&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">// PetTypeOther captures the enum value &quot;OTHER&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetTypeOther PetType </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;OTHER&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">// PetTypeRat captures the enum value &quot;RAT&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetTypeRat PetType </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;RAT&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">// PetTypeSnake captures the enum value &quot;SNAKE&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetTypeSnake PetType </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;SNAKE&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">// PetTypeTurtle captures the enum value &quot;TURTLE&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetTypeTurtle PetType </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;TURTLE&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// Pet contains all the information relevant to a pet...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> Pet </span><span class="token keyword" style="color:#c5a5c5">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    ID        uuid</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">UUID   </span><span class="token string" style="color:#8dc891">`json:&quot;id&quot; db:&quot;id&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    CreatedAt time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time   </span><span class="token string" style="color:#8dc891">`json:&quot;created_at&quot; db:&quot;created_at&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    UpdatedAt time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time   </span><span class="token string" style="color:#8dc891">`json:&quot;updated_at&quot; db:&quot;updated_at&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Type      PetType     </span><span class="token string" style="color:#8dc891">`json:&quot;type&quot; db:&quot;type&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Name      </span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain">      </span><span class="token string" style="color:#8dc891">`json:&quot;name&quot; db:&quot;name&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Birthday  </span><span class="token operator" style="color:#d7deea">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time  </span><span class="token string" style="color:#8dc891">`json:&quot;birthday&quot; db:&quot;birthday&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    GotchaDay </span><span class="token operator" style="color:#d7deea">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time  </span><span class="token string" style="color:#8dc891">`json:&quot;gotcha_day&quot; db:&quot;gotcha_day&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Bio       </span><span class="token operator" style="color:#d7deea">*</span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain">     </span><span class="token string" style="color:#8dc891">`json:&quot;bio&quot; db:&quot;bio&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Weight    </span><span class="token operator" style="color:#d7deea">*</span><span class="token plain">unit</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Pound </span><span class="token string" style="color:#8dc891">`json:&quot;weight&quot; db:&quot;weight&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// TableName overrides the table name used by Pop.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">p Pet</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">TableName</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;pets&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// Pets is a list of Pets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> Pets </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain">Pet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Some things to note:</p><ol><li>The field names here are pascal case, while in the struct tags, we use the snake case version. </li><li>Notice how we used <code>string</code> for <code>Name</code>, while we used <code>*string</code> for <code>Bio</code>. We have a loose convention around
using pointers for optional (nullable) fields, and the concrete type for required fields.<ol><li>One important thing to note here is that this will affect patch requests if you want the API caller to be
able to make a request without passing in all the non-nullable fields each time. Some options which we use
for existing models:<ol><li>Make the field a pointer on the model. This means you will need to have validation somewhere though to
ensure that we save a valid value to the DB in the end.</li><li>Follow a pattern similar to the
<a href="https://github.com/transcom/mymove/blob/088b87605f19b18b022ff718fcbd5eb8f6962585/pkg/services/ppmshipment/ppm_shipment_updater.go#L44-L49" target="_blank" rel="noopener noreferrer">PPM shipment updater</a>
which merges the new and old shipment <em>before</em> validating the shipment.</li></ol></li></ol></li><li>We define the plural <code>type</code>, <code>Pets</code> under the main struct as a slice of the type.<ol><li>You might see some models that don&#x27;t follow this pattern, but generally we prefer to follow it so if you are
adding a new table it&#x27;s best to stick with this pattern.</li></ol></li><li>We define a custom <code>string</code> <code>type</code>, <code>PetType</code>, that constrains the valid values for <code>Pet.Type</code>. This maps to
the enum we created in the <code>sql</code> migration.</li></ol></li><li><p>Now you will want to run the migration to test it out with <code>make db_dev_migrate</code>.</p></li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="example-of-relationships">Example of Relationships<a href="#example-of-relationships" class="hash-link" aria-label="Direct link to Example of Relationships" title="Direct link to Example of Relationships">​</a></h4><p>To showcase an example of a table with relationships, we can look at what it would look like to add a model <code>Cat</code>
with corresponding table <code>cats</code>. This will be a child of the <code>Pet</code> model, so we&#x27;ll use the corresponding field type
and attributes. The steps for creating the table and model are the same as in the previous section so we&#x27;ll just
focus on what the files would look like in the end:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> cats</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    id uuid </span><span class="token keyword" style="color:#c5a5c5">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">KEY</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    pet_id uuid </span><span class="token operator" style="color:#d7deea">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">CONSTRAINT</span><span class="token plain"> cats_pets_id_fkey</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">REFERENCES</span><span class="token plain"> pets</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    created_at </span><span class="token keyword" style="color:#c5a5c5">timestamp</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    updated_at </span><span class="token keyword" style="color:#c5a5c5">timestamp</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    likes_catnip </span><span class="token keyword" style="color:#c5a5c5">bool</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    favorite_catnip_brand </span><span class="token keyword" style="color:#c5a5c5">text</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    favorite_cat_scratcher_type </span><span class="token keyword" style="color:#c5a5c5">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> cats </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;Store cats and their details.&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> cats</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">likes_catnip </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;Indicates whether the cat likes catnip or not.&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> cats</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">favorite_catnip_brand </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;If the cat does like catnip, this will store the name of their favorite brand&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMENT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">on</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> cats</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">favorite_cat_scratcher_type </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;Favorite type of cat scratcher, e.g. floor, wall, tower, etc.&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Things to note:</p><ul><li>We define the relationship between the two tables using the field <code>pet_id</code></li><li><code>pet_id</code> has a type of <code>uuid</code> and is not nullable because for this relationship, we expect there to exist a row in
<code>pets</code> for every row in <code>cats</code></li><li>The <code>CONSTRAINT</code> name is something you choose. Name it something that quickly indicates what it is for, e.g. which
two tables are involved. </li><li>You point <code>pet_id</code> at the table it references, in our case, <code>pets</code></li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockTitle_Ktv7">pkg/models/cat.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">package</span><span class="token plain"> models</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&quot;github.com/gofrs/uuid&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// Cat contains all the information relevant to a cat...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> Cat </span><span class="token keyword" style="color:#c5a5c5">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    ID                       uuid</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">UUID </span><span class="token string" style="color:#8dc891">`json:&quot;id&quot; db:&quot;id&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    PetID                    uuid</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">UUID </span><span class="token string" style="color:#8dc891">`json:&quot;pet_id&quot; db:&quot;pet_id&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Pet                      Pet       </span><span class="token string" style="color:#8dc891">`belongs_to:&quot;pets&quot; fk_id:&quot;pet_id&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    CreatedAt                time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time </span><span class="token string" style="color:#8dc891">`json:&quot;created_at&quot; db:&quot;created_at&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    UpdatedAt                time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time </span><span class="token string" style="color:#8dc891">`json:&quot;updated_at&quot; db:&quot;updated_at&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    LikesCatnip              </span><span class="token operator" style="color:#d7deea">*</span><span class="token builtin" style="color:#D8DEE9">bool</span><span class="token plain">     </span><span class="token string" style="color:#8dc891">`json:&quot;likes_catnip&quot; db:&quot;likes_catnip&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    FavoriteCatnipBrand      </span><span class="token operator" style="color:#d7deea">*</span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain">   </span><span class="token string" style="color:#8dc891">`json:&quot;favorite_catnip_brand&quot; db:&quot;favorite_catnip_brand&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    FavoriteCatScratcherType </span><span class="token operator" style="color:#d7deea">*</span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain">   </span><span class="token string" style="color:#8dc891">`json:&quot;favorite_cat_scratcher_type&quot; db:&quot;favorite_cat_scratcher_type&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// TableName overrides the table name used by Pop.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">c Cat</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">TableName</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;cats&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// Cats is a list of Cats</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> Cats </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain">Cat</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Things to note:</p><ul><li>We have the <code>PetID</code> that corresponds to the <code>pet_id</code> field we defined in the migration.</li><li>We have a separate field, <code>Pet</code>, that will store the data for the related model. <ul><li>So for example, if you want access to the name of the pet, and you have an instance of a <code>Cat</code>, <code>originalCat</code>,
then you could access the name using <code>originalCat.Pet.Name</code></li><li>This field doesn&#x27;t have a corresponding field on the table or in the migration. It is something that is entirely
for ease of access and something which <code>Pop</code> (our ORM) understands. Note that this field being here doesn&#x27;t mean
the data is automatically loaded whenever you fetch a <code>cat</code> row from the database; your query will need to do
the necessary joins to get the related record back.</li><li>In the <code>struct</code> tags, we define that this field belongs to the <code>pets</code> table and that the <code>fk_id</code> (foreign key ID)
is the <code>pet_id</code> field on the <code>cats</code> table.</li></ul></li></ul><p>We&#x27;ll also want to update our <code>Pet</code> model to point back at our <code>Cat</code> model:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockTitle_Ktv7">pkg/models/pet.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">package</span><span class="token plain"> models</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&quot;github.com/gofrs/uuid&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&quot;github.com/transcom/mymove/pkg/unit&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// PetType omitted for brevity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// Pet contains all the information relevant to a pet...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> Pet </span><span class="token keyword" style="color:#c5a5c5">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    ID        uuid</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">UUID   </span><span class="token string" style="color:#8dc891">`json:&quot;id&quot; db:&quot;id&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    CreatedAt time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time   </span><span class="token string" style="color:#8dc891">`json:&quot;created_at&quot; db:&quot;created_at&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    UpdatedAt time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time   </span><span class="token string" style="color:#8dc891">`json:&quot;updated_at&quot; db:&quot;updated_at&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Type      PetType     </span><span class="token string" style="color:#8dc891">`json:&quot;type&quot; db:&quot;type&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Name      </span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain">      </span><span class="token string" style="color:#8dc891">`json:&quot;name&quot; db:&quot;name&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Birthday  </span><span class="token operator" style="color:#d7deea">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time  </span><span class="token string" style="color:#8dc891">`json:&quot;birthday&quot; db:&quot;birthday&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    GotchaDay </span><span class="token operator" style="color:#d7deea">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Time  </span><span class="token string" style="color:#8dc891">`json:&quot;gotcha_day&quot; db:&quot;gotcha_day&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Bio       </span><span class="token operator" style="color:#d7deea">*</span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain">     </span><span class="token string" style="color:#8dc891">`json:&quot;bio&quot; db:&quot;bio&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    Weight    </span><span class="token operator" style="color:#d7deea">*</span><span class="token plain">unit</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Pound </span><span class="token string" style="color:#8dc891">`json:&quot;weight&quot; db:&quot;weight&quot;`</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">    Cat       </span><span class="token operator" style="color:#d7deea">*</span><span class="token plain">Cat        </span><span class="token string" style="color:#8dc891">`has_one:&quot;cats&quot; fk_id:&quot;pet_id&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// TableName overrides the table name used by Pop.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">p Pet</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">TableName</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token builtin" style="color:#D8DEE9">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;pets&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">// Pets is a list of Pets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> Pets </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain">Pet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that this is similar to the <code>Pet</code> field on the <code>Cat</code> model in that it is purely a nice feature that <code>Pop</code> lets
us use to more easily go across relationships.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tablename-method">TableName method<a href="#tablename-method" class="hash-link" aria-label="Direct link to TableName method" title="Direct link to TableName method">​</a></h4><p><a href="https://gobuffalo.io/documentation/database/models/#using-a-custom-table-name" target="_blank" rel="noopener noreferrer">Pop&#x27;s <code>TableName</code> method</a> above is
technically optional. If you don&#x27;t include it, Pop will attempt to guess the table  name by parsing the model&#x27;s name
into words separated by underscores and then making that plural. However, in practice we&#x27;ve found that algorithm does
not work the way we would like with acronyms (like <code>PPMShipment</code>) or with some  attempts at pluralization (since
pluralization can be complicated). So, we require a <code>TableName</code> method on quite a few models. Rather than put
<code>TableName</code> on selected models and rely on Pop&#x27;s automatic table name determination for the others, we now include
<code>TableName</code> on <em>all</em> models for consistency and resiliency to future changes in the table name algorithm.</p><p>Also, note this about the <code>TableName</code> method per
<a href="https://gobuffalo.io/documentation/database/models/#using-a-custom-table-name" target="_blank" rel="noopener noreferrer">Pop&#x27;s documentation</a>:</p><blockquote><p>It is recommended to use a value receiver over a pointer receiver if the struct is used as a value anywhere in the code.</p></blockquote><p>We have run into problems using a pointer receiver for <code>TableName</code>, perhpas due to the fact that Pop often treats
models internally as type <code>interface{}</code> in its algorithms, and an
<a href="https://stackoverflow.com/questions/40823315/x-does-not-implement-y-method-has-a-pointer-receiver" target="_blank" rel="noopener noreferrer">interface doesn&#x27;t play well with pointer receivers</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-migrations">Running Migrations<a href="#running-migrations" class="hash-link" aria-label="Direct link to Running Migrations" title="Direct link to Running Migrations">​</a></h2><p>Migrations are run by the <code>milmove migrate</code> command. This allows us to leverage different authentication methods for migrations in development and in production using the same code. To migrate you should use a command based on your DB:</p><ul><li><code>make db_dev_migrate</code></li><li><code>make db_test_migrate</code></li><li><code>make db_deployed_migrations_migrate</code></li></ul><p>The reason to use a <code>make</code> target is because it will correctly set the migration flag variables and target the correct database with environment variables.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="update-migrations-locally">Update Migrations Locally<a href="#update-migrations-locally" class="hash-link" aria-label="Direct link to Update Migrations Locally" title="Direct link to Update Migrations Locally">​</a></h2><p>In the event that you need to make an edit to a migration that you have just created prior to merging it into the main branch,
you can update the migration with your edits and rerun it using: </p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">make db_dev_reset db_dev_migrate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This command will reset the database and re-add all migrations, including your updated one. Double check that you see
the database changes after making your edits and running the <code>make</code> commands. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="secure-migrations">Secure Migrations<a href="#secure-migrations" class="hash-link" aria-label="Direct link to Secure Migrations" title="Direct link to Secure Migrations">​</a></h2><blockquote><p>❗️ <strong>Before adding SSNs or other PII, please consult with Infra.</strong></p></blockquote><p>We are piggy-backing on the migration system for importing static datasets. This approach causes problems if the data isn&#x27;t public, as all of the migrations are in this open source repository. To address this, we have what are called &quot;secure migrations.&quot;</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-secure-migrations">Creating Secure Migrations<a href="#creating-secure-migrations" class="hash-link" aria-label="Direct link to Creating Secure Migrations" title="Direct link to Creating Secure Migrations">​</a></h3><ol><li><p>Set up a local <code>deployed_migrations</code> database by running:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token function" style="color:#79b6f2">make</span><span class="token plain"> run_prd_migrations</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will help you test the migration you are creating later.</p></li><li><p>Generate new migration files with <code>generate-secure-migration &lt;migration_name&gt;</code>. This creates two migration files:</p><ul><li>a file in <code>migrations/app/secure</code> with no secret data. This one will be used to set up the dev db</li><li>a file in <code>tmp</code> which will be uploaded to S3 and contain sensitive data</li></ul></li><li><p>Edit the production migration first, and put whatever sensitive data in it that you need to.</p></li><li><p>Copy the production migration into the local test migration.</p></li><li><p>Scrub the test migration of sensitive data, but use it to test the gist of the production migration operation.</p></li><li><p>Test the local secure migration by running:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token function" style="color:#79b6f2">make</span><span class="token plain"> db_dev_migrate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see it run your new secure migration (with non-sensitive data).</p></li><li><p>Then verify the secure migration with sensitive data works by running:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">psql-deployed-migrations</span><span class="token operator" style="color:#d7deea">&lt;</span><span class="token plain"> tmp/</span><span class="token variable" style="color:#d7deea">$NAME_OF_YOUR_SECURE_MIGRATION</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will load the sensitive data into the local <code>deployed_migrations</code> database.</p><ol><li><strong>NOTE:</strong> This is not going to wrap the migration in a transaction. If it fails partway through, you&#x27;ll need to clean it up or start fresh. If you do want to start fresh, you can:<ol><li>Comment out your secure migration in <code>migrations/app/migrations_manifest.txt</code>. Add a <code># </code> in front of it to comment it out.</li><li>Then run:<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token function" style="color:#79b6f2">make</span><span class="token plain"> run_prd_migrations</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>Now you can re-run the <code>psql</code> line that is posted above.</li></ol></li></ol></li><li><p>If you are wanting to run a secure migration for a specific non-production environment, then <a href="#Secure-Migrations-for-One-Environment"><strong>skip to the next section</strong></a>. Otherwise,</p></li><li><p>Upload the migration to S3 with:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">upload-secure-migration </span><span class="token operator" style="color:#d7deea">&lt;</span><span class="token plain">production_migration_file</span><span class="token operator" style="color:#d7deea">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>NOTE:</strong> For a single environment see <a href="#Secure-Migrations-for-One-Environment">the next section</a>.</p></li><li><p>Verify that the upload worked and the migration can be applied successfully by running:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token function" style="color:#79b6f2">make</span><span class="token plain"> run_prd_migrations</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>If not, you can make changes and re-upload. It will overwrite the old files.</li></ol></li><li><p>Once the migration is working properly, <strong>delete the secure migration from your <code>tmp</code> directory</strong> if you didn&#x27;t delete it when the upload script prompted you in a previous step.</p></li><li><p>Open a pull request!</p></li><li><p>When the pull request merges, the production migrations will be run on Staging and Prod.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="secure-migrations-for-one-environment">Secure Migrations for One Environment<a href="#secure-migrations-for-one-environment" class="hash-link" aria-label="Direct link to Secure Migrations for One Environment" title="Direct link to Secure Migrations for One Environment">​</a></h3><p>To run a secure migration on ONLY staging (or other chosen environment), upload the migration only to the S3 environment and blank files to the others. </p><ol><li><p>Similar to the &quot;Upload the migration&quot; step above, run <code>ENVIRONMENTS=&quot;stg&quot; upload-secure-migration &lt;production_migration_file&gt;</code> where <code>ENVIRONMENTS</code> is a quoted list of all the environments you wish to upload to. The default is <code>&quot;demo exp stg prd loadtest&quot;</code> but you can just do staging and production with <code>ENVIRONMENTS=&quot;stg prd&quot;</code></p></li><li><p>Check that it is listed in the S3 staging secure-migrations folder. For GovCloud account that would be <code>DISABLE_AWS_VAULT_WRAPPER=1 AWS_PROFILE=transcom-gov-id AWS_REGION=us-gov-west-1 aws-vault exec transcom-gov-milmove-stg -- aws s3 ls s3://transcom-gov-milmove-stg-app-us-gov-west-1/secure-migrations/</code>.</p></li><li><p>Check that it is NOT listed in the S3 production folder. GovCloud: <code>DISABLE_AWS_VAULT_WRAPPER=1 AWS_PROFILE=transcom-gov-id AWS_REGION=us-gov-west-1 aws-vault exec transcom-gov-milmove-stg -- aws s3 ls s3://transcom-gov-milmove-prd-app-us-gov-west-1/secure-migrations/</code>.</p></li><li><p>Now upload empty files of the same name to the prd, exp, demo, and loadtest environments: <code>ENVIRONMENTS=&quot;exp prd demo loadtest&quot; upload-secure-migration &lt;empty_migration_file_with_same_name&gt;</code></p></li><li><p>To verify upload and that the migration can be applied use the make target corresponding to your environment:</p><ul><li><code>make run_prd_migrations</code></li><li><code>make run_stg_migrations</code></li><li><code>make run_exp_migrations</code></li><li><code>make run_demo_migrations</code></li><li><code>make run_loadtest_migrations</code></li></ul></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-secure-migrations-work">How Secure Migrations Work<a href="#how-secure-migrations-work" class="hash-link" aria-label="Direct link to How Secure Migrations Work" title="Direct link to How Secure Migrations Work">​</a></h3><p>When migrations are run the <code>$MIGRATION_MANIFEST</code> will be checked against files inside the paths listed in
<code>$MIGRATION_PATH</code> (a semicolon separated list of local <code>file://</code> or AWS S3 <code>s3://</code> paths). The migration code
will then run each migration listed in the manifest in order of the Version (which is typically a time stamp
at the front of a file).</p><ul><li>Look at <code>$MIGRATION_MANIFEST</code> to determine list of migrations to run (anything not listed will not be run, anything listed but missing will throw an error)</li><li>Look at <code>$MIGRATION_PATH</code> to find files locally or in AWS S3. See the <code>Makefile</code> for examples.</li><li>If the file is to be found on S3, it is streamed directly into memory instead of downloading.</li><li>If it is to be found locally, the script looks for it in the listed path.</li></ul><p>There is an example of local secure migrations <a href="https://github.com/transcom/mymove/blob/main/migrations/app/secure" target="_blank" rel="noopener noreferrer">in the repo</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="downloading-secure-migrations">Downloading Secure Migrations<a href="#downloading-secure-migrations" class="hash-link" aria-label="Direct link to Downloading Secure Migrations" title="Direct link to Downloading Secure Migrations">​</a></h3><p><strong>NOTE:</strong> Be careful with downloading secure migrations. They often contain sensitive input and should be treated with care. When you are done with these secure migrations please delete them from your computer.</p><p>You may need to download and inspect secure migrations. Or perhaps you need to correct a file you uploaded by mistake. Here is how you download the secure migrations:</p><ul><li>Download the migration to S3 with: <code>download-secure-migration &lt;production_migration_file&gt;</code>. You can also use the <code>ENVIRONMENTS</code> environment variable to specify one or more than one environment (exp, stg, prd, demo, loadtest).</li><li>This will put files in <code>./tmp/secure_migrations/${environment}</code>.</li></ul><p>You can now inspect or modify and re-upload those files as needed. Running the script will look like this:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token assign-left variable" style="color:#d7deea">ENVIRONMENTS</span><span class="token operator" style="color:#d7deea">=</span><span class="token string" style="color:#8dc891">&quot;exp stg prd demo loadtest&quot;</span><span class="token plain"> download-secure-migration 20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Downloading from: exp</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">download: s3://transcom-gov-milmove-exp-app-us-gov-west-1/secure-migrations/20200911161101_secure_migration.up.sql to ./tmp/secure_migrations/exp/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Downloading from: stg</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">download: s3://transcom-gov-milmove-stg-app-us-gov-west-1/secure-migrations/20200911161101_secure_migration.up.sql to ./tmp/secure_migrations/stg/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Downloading from: prd</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">.download: s3://transcom-gov-milmove-prd-app-us-gov-west-1/secure-migrations/20200911161101_secure_migration.up.sql to ./tmp/secure_migrations/prd/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Downloading from: demo</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">.download: s3://transcom-gov-milmove-demo-app-us-gov-west-1/secure-migrations/20200911161101_secure_migration.up.sql to ./tmp/secure_migrations/demo/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Downloading from: loadtest</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">.download: s3://transcom-gov-milmove-loadtest-app-us-gov-west-1/secure-migrations/20200911161101_secure_migration.up.sql to ./tmp/secure_migrations/loadtest/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Files have been downloaded to these locations:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">./tmp/secure_migrations/prd/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">./tmp/secure_migrations/exp/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">./tmp/secure_migrations/stg/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">./tmp/secure_migrations/demo/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">./tmp/secure_migrations/loadtest/20200911161101_secure_migration.up.sql</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Please remember to </span><span class="token string" style="color:#8dc891">&#x27;rm -rf ./tmp/secure_migrations&#x27;</span><span class="token plain"> when you are finished working</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-we-avoid-uuid_generate_v4">Why we avoid <code>uuid_generate_v4()</code><a href="#why-we-avoid-uuid_generate_v4" class="hash-link" aria-label="Direct link to why-we-avoid-uuid_generate_v4" title="Direct link to why-we-avoid-uuid_generate_v4">​</a></h3><p>We avoid the use of <code>uuid_generate_v4()</code> for scripts that add data to the database (especially generating primary keys) because:</p><ul><li>It make running migrations multiple times end up with different results.</li><li>It makes it hard to use primary keys generated this way as foreign keys in other migrations.</li><li>It raises the remote possibility that a migration works in one system and fails in another.</li><li>With specific UUIDs we were able to track down users in each system. When using <code>uuid_generate_v4()</code>, we have no way of telling what UUID people were assigned on remote machines so we lose the ability to identify them locally.</li></ul><p>For more details see this <a href="https://ustcdp3.slack.com/archives/CP6PTUPQF/p1559840327095700" target="_blank" rel="noopener noreferrer">slack thread</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="zero-downtime-migrations">Zero-Downtime Migrations<a href="#zero-downtime-migrations" class="hash-link" aria-label="Direct link to Zero-Downtime Migrations" title="Direct link to Zero-Downtime Migrations">​</a></h3><p>As a good practice, all of our migrations should create a database state that works both with the current version of the application code <em>and</em> the new version of the application code. This allows us to run migrations before the new app code is live without creating downtime for our users. More in-depth list of migrations that might cause issues are outlined in our <a href="https://docs.google.com/document/d/1q-Ho5NINRPpsHQI-DjmLrDlzHsBh-hUc" target="_blank" rel="noopener noreferrer">google drive</a>.</p><p><a href="https://github.com/ankane/strong_migrations" target="_blank" rel="noopener noreferrer">strong-migrations</a> is another great resource with detailed documentation and an exhaustive list of dangerous operations. The code examples are for Rails, but the same principles apply.</p><p>Eg: If we need to rename a column, doing a traditional rename would cause the app to fail if the database changes went live before the new application code (pointing to the new column name) went live. Instead, this should be done in [six steps[(<a href="https://github.com/ankane/strong_migrations#renaming-a-column" target="_blank" rel="noopener noreferrer">https://github.com/ankane/strong_migrations#renaming-a-column</a>), where each step gets deployed separately:</p><ol><li>Create a new column</li><li>Write to both columns</li><li>Backfill data from the old column to the new column</li><li>Move reads from the old column to the new column</li><li>Stop writing to the old column</li><li>Drop the old column</li></ol><p>Similarly, if a column needs to be dropped, we should deprecate the column in one pull request and then actually remove it in a follow-up pull request. Deprecation can be done by renaming the column to <code>deprecated_column_name</code>. This process has an added side affect of helping us keep our migrations reversible, since columns can always be re-added, but getting old data back into those columns is a more difficult process.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/transcom/mymove-docs/edit/main/docs/backend/setup/database-migrations.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/mymove-docs/docs/backend/setup/backup-and-restore-dev-database"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">How To Backup and Restore the Development Database</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/mymove-docs/docs/backend/setup/run-pre-commit-hooks"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Run pre-commit hooks</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#understanding-migrations" class="table-of-contents__link toc-highlight">Understanding Migrations</a></li><li><a href="#setup" class="table-of-contents__link toc-highlight">Setup</a></li><li><a href="#creating-migrations" class="table-of-contents__link toc-highlight">Creating Migrations</a><ul><li><a href="#milmove-gen-command" class="table-of-contents__link toc-highlight"><code>milmove gen</code> command</a></li><li><a href="#writing-migrations" class="table-of-contents__link toc-highlight">Writing migrations</a></li><li><a href="#adding-a-new-table" class="table-of-contents__link toc-highlight">Adding a new table</a></li></ul></li><li><a href="#running-migrations" class="table-of-contents__link toc-highlight">Running Migrations</a></li><li><a href="#update-migrations-locally" class="table-of-contents__link toc-highlight">Update Migrations Locally</a></li><li><a href="#secure-migrations" class="table-of-contents__link toc-highlight">Secure Migrations</a><ul><li><a href="#creating-secure-migrations" class="table-of-contents__link toc-highlight">Creating Secure Migrations</a></li><li><a href="#secure-migrations-for-one-environment" class="table-of-contents__link toc-highlight">Secure Migrations for One Environment</a></li><li><a href="#how-secure-migrations-work" class="table-of-contents__link toc-highlight">How Secure Migrations Work</a></li><li><a href="#downloading-secure-migrations" class="table-of-contents__link toc-highlight">Downloading Secure Migrations</a></li></ul></li><li><a href="#notes" class="table-of-contents__link toc-highlight">Notes</a><ul><li><a href="#why-we-avoid-uuid_generate_v4" class="table-of-contents__link toc-highlight">Why we avoid <code>uuid_generate_v4()</code></a></li><li><a href="#zero-downtime-migrations" class="table-of-contents__link toc-highlight">Zero-Downtime Migrations</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/about">About MilMove</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/adrs">Architecture Decision Records</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/frontend">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/backend">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/api">API</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/tools">Tools</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/transcom/mymove-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">MilMove Documentation GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="footer__link-item">MilMove GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://6130eb5cde15830007fdf57b--docusaurus-2.netlify.app/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2023  U.S. Federal Government (in countries where recognized) and TrussWorks. Built with Docusaurus.</div></div></div></footer></div>
<script src="/mymove-docs/assets/js/runtime~main.2d8cf14e.js"></script>
<script src="/mymove-docs/assets/js/main.72cd5155.js"></script>
</body>
</html>