<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-backend/guides/tspp-data-creation">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Turning TDL scores and TSP discounts into transportation service provider performances | MilMove Developer Portal</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://transcom.github.io/mymove-docs/docs/backend/guides/tspp-data-creation"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Turning TDL scores and TSP discounts into transportation service provider performances | MilMove Developer Portal"><meta data-rh="true" name="description" content="This outlines the steps you need to do to join the two data sources we&#x27;ve traditionally gotten - CSVs or text files of best value scores tied to TDLs, exported one code of service at a time, and CSVs or text files of TSP discount rates, organized by the three pieces of data that make up a TDL (origin, destination, and code of service). If anything behaves in a surprising way, double check the schema detailed here against the organization of your input files. No step of this should alter zero rows, for instance."><meta data-rh="true" property="og:description" content="This outlines the steps you need to do to join the two data sources we&#x27;ve traditionally gotten - CSVs or text files of best value scores tied to TDLs, exported one code of service at a time, and CSVs or text files of TSP discount rates, organized by the three pieces of data that make up a TDL (origin, destination, and code of service). If anything behaves in a surprising way, double check the schema detailed here against the organization of your input files. No step of this should alter zero rows, for instance."><link data-rh="true" rel="icon" href="/mymove-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://transcom.github.io/mymove-docs/docs/backend/guides/tspp-data-creation"><link data-rh="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/backend/guides/tspp-data-creation" hreflang="en"><link data-rh="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/backend/guides/tspp-data-creation" hreflang="x-default"><link rel="stylesheet" href="/mymove-docs/assets/css/styles.65849403.css">
<link rel="preload" href="/mymove-docs/assets/js/runtime~main.2d8cf14e.js" as="script">
<link rel="preload" href="/mymove-docs/assets/js/main.72cd5155.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mymove-docs/"><div class="navbar__logo"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">MilMove Documentation</b></a><a class="navbar__item navbar__link" href="/mymove-docs/docs/about/">About</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/adrs">ADRs</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/frontend">Frontend</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/mymove-docs/docs/backend">Backend</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/integrations">Integrations</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/api">API</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/tools">Tools</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/help/index">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">mymove<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/mymove-docs/docs/backend">MilMove Backend</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mymove-docs/docs/backend/testing/acceptance-testing-syncada-edi-invoicing">Testing</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/mymove-docs/docs/backend/guides/service-objects/overview">Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/mymove-docs/docs/backend/guides/service-objects/overview">Service Objects</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/backend-structure">Backend Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/tariff400ng_items-update-data">Adding ShipmentLineItem records to the 400ng table (tariff400ng_items)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/database">Database Guides</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/feature-flags-in-the-app">Feature flags in the app</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/mymove-docs/docs/backend/guides/ghc/ghc-invoicing">Global Household Goods Contract</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/mymove-docs/docs/backend/guides/how-to/add-an-event-trigger">How-to guides</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/troubleshoot-gex-connection">Troubleshoot GEX Connection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/tariff400ng-yearly-import">Importing tariff400ng data for the year</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/troubleshoot-precommit-hook-failures">Precommit Hooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/route-planner">Route Planner Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/session-management">Session management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/roles-and-permissions">Roles and Permissions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/switching-over-to-nix">Switching over to Nix</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/golang-time">Time in Golang</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/golang-loops">Loop Iteration in Golang</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mymove-docs/docs/backend/guides/tspp-data-creation">Turning TDL scores and TSP discounts into transportation service provider performances</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/use-optimistic-locking">What Is Optimistic Locking?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/zip-code-to-rate-area-mappings">Zip code to Rate area mappings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/wip-server-side-validation">WIP server-side validation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/debugging-sql-tests">Debugging SQL Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/guide-to-history-and-audit-logging">History and Audit Logging Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/open-telemetry">Open Telemetry</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/mymove-docs/docs/backend/guides/environment_variables/">Environment Variables</a><button aria-label="Toggle the collapsible sidebar category &#x27;Environment Variables&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/golang-guide">Golang Programming Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/understanding-milmove-routing">Understanding MilMove Routing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/use-stateless-services-with-app-context">AppContext: how and when to use it</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mymove-docs/docs/backend/setup/configure-postico-or-tableplus-to-connect-to-mymove-db">Setup</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/mymove-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Guides</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Turning TDL scores and TSP discounts into transportation service provider performances</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Turning TDL scores and TSP discounts into transportation service provider performances</h1><p>This outlines the steps you need to do to join the two data sources we&#x27;ve traditionally gotten - CSVs or text files of best value scores tied to TDLs, exported one code of service at a time, and CSVs or text files of TSP discount rates, organized by the three pieces of data that make up a TDL (origin, destination, and code of service). If anything behaves in a surprising way, double check the schema detailed here against the organization of your input files. No step of this should alter zero rows, for instance.</p><p>Before you begin this process, convert discount rate Excel files or TXT files to
CSVs, if needed. <strong>Verify that values for SVY_SCORE, RATE_SCORE, and BVS are
decimal values (should be formatted like <code>77.3456</code>).</strong></p><blockquote><p>We will use the <code>\copy</code> <code>psql</code> command throughout this guide.</p><p><code>\copy</code> is a simpler way of getting this into the db because it requires less in the way of user permissions (unlike the <code>COPY</code> command). Use your absolute path for where you stored those CSV files.</p></blockquote><p>Note: If you wish to view existing data from production, use the command <code>bin/run-prod-migrations</code>. The local development <code>dev-db</code>
does not contain the full set of data. You should not need to run the command <code>bin/run-prod-migrations</code> to complete the steps outlined here.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="verify-input-files">Verify Input Files<a href="#verify-input-files" class="hash-link" aria-label="Direct link to Verify Input Files" title="Direct link to Verify Input Files">​</a></h2><p>Check that the files you are about to import have roughly the correct number of lines in them:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tdl-scores">TDL Scores<a href="#tdl-scores" class="hash-link" aria-label="Direct link to TDL Scores" title="Direct link to TDL Scores">​</a></h3><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">496592   TDL Scores - 1Aug2018 PP - NP - Code 2.csv</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">496592   TDL Scores - 1Aug2018 PP - PK - Code 2.csv</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">565673   TDL Scores - 1Aug2018 PP - NP - Code D.csv</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">565673   TDL Scores - 1Aug2018 PP - PK - Code D.csv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tsp-rates">TSP Rates<a href="#tsp-rates" class="hash-link" aria-label="Direct link to TSP Rates" title="Direct link to TSP Rates">​</a></h3><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">496593   2018 Code 2 NonPeak Rates.txt</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">496593   2018 Code 2 Peak Rates.txt</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">565674   2018 Code D NonPeak Rates.txt</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">565674   2018 Code D Peak Rates.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tdl-performance-dates-vs-tsp-rate-dates">TDL Performance Dates vs TSP Rate Dates<a href="#tdl-performance-dates-vs-tsp-rate-dates" class="hash-link" aria-label="Direct link to TDL Performance Dates vs TSP Rate Dates" title="Direct link to TDL Performance Dates vs TSP Rate Dates">​</a></h3><p>Note that Rates overlap Performance Periods. You may get a new set of TDLs and will have to use existing (Non)Peak Rates.
E.g., To load the performance data for <code>Performance Period 1</code> 2019 the 2018 <code>* NonPeak Rates.txt</code> files were used.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">Rate Cycle:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Peak: 5/15 to 9/30</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Performance Periods</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">1: 1/1   to  5/14</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">2: 5/15  to  7/31</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">3: 8/1   to  9/30</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">4: 10/1  to  12/31</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+--------------------------------------------------------------------------------------------+-----------------------------+</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">| 2018                                                                                       | 2019                        |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+--------------------------------------------------------------------------------------------+-----------------------------+</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">| Rate Cycle Rate - Non Peak (2017)     | Rate Cycle Rate - Peak (2018)    | Rate Cycle Rate - Non Peak (2018)          |  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+---------------------------------------+----------------------------------+--------------------------------------------+--+</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">| Perf Period 1                         | Perf Period 2    | Perf Period 3 | Perf Period 4   | Perf Period 1            |  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+------------------------------------------+---------------+---------------+-----------------+-----------------------------+</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">| Jan    | Feb    | Mar    | Apr    | May  | Jun   | Jul   | Aug   | Sept  | Oct | Nov | Dec | Jan | Feb | Mar | Apr | May |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+--------+--------+--------+--------+------+-------+-------+-------+-------+-----+-----+-----+-----+-----+-----+-----+-----+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="load-tsp-discount-rates">Load TSP Discount Rates<a href="#load-tsp-discount-rates" class="hash-link" aria-label="Direct link to Load TSP Discount Rates" title="Direct link to Load TSP Discount Rates">​</a></h2><blockquote><p>If this isn&#x27;t your first time at the data-loading rodeo today:
<code>DROP TABLE IF EXISTS temp_tsp_discount_rates;</code></p></blockquote><p>Create a table to hold the incoming data:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">CREATE TABLE temp_tsp_discount_rates (</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  rate_cycle text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  origin text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  destination text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  cos text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  scac text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  lh_rate numeric(6,2),</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  sit_rate numeric(6,2)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The files you need now will include the linehaul and SIT discounts and may have a name like <code>2018 Code 2 Peak Rates.txt</code>. The &quot;rates&quot; part is what you&#x27;re looking for: key columns are LH_RATE and SIT_RATE.</p><p>You will need to import <strong>two</strong> files, one for each code of service in the part of the rate cycle that applies to the TDL data you just imported.</p><ul><li>If your TDL data is during the peak part of the rate cycle (May 15th -
September 30th), import the <strong>peak</strong> rates.</li><li>Otherwise, import the <strong>non-peak</strong> rates.</li></ul><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">\copy temp_tsp_discount_rates </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;/add/filename/for/discount/rates/2018 Code D Peak Rates.csv&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">WITH</span><span class="token plain"> CSV HEADER</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">\copy temp_tsp_discount_rates </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;/add/filename/for/discount/rates/2018 Code 2 Peak Rates.csv&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">WITH</span><span class="token plain"> CSV HEADER</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="load-tsp-best-value-scores-from-tdl-data">Load TSP Best Value Scores from TDL data<a href="#load-tsp-best-value-scores-from-tdl-data" class="hash-link" aria-label="Direct link to Load TSP Best Value Scores from TDL data" title="Direct link to Load TSP Best Value Scores from TDL data">​</a></h2><p>Now, let&#x27;s get those best value scores. This file will likely have &quot;TDL scores&quot; in the title. Key columns are RANK and BVS.</p><blockquote><p>In case you already made this table...
<code>DROP TABLE IF EXISTS temp_tdl_scores;</code></p></blockquote><p>Duplicate the format of TDL scores CSVs:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">CREATE TABLE temp_tdl_scores (</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  market text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  origin text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  destination text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  cos text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  quartile int,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  rank int,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  scac text,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  svy_score numeric(8,4),</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  rate_score numeric(8,4),</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  bvs numeric(8,4)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Use the <code>\copy</code> command in psql again to import the TDL scores. Again, you&#x27;ll
need to import <strong>two</strong> files based on whether the dates you are working with are
in the peak or non-peak season. Use your absolute path for where you stored those
CSV files.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">\copy temp_tdl_scores </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;/add/filename/for/tdl/scores/TDL Scores - 1Aug2018 PP - PK - Code D.csv&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">WITH</span><span class="token plain"> CSV HEADER</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">\copy temp_tdl_scores </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;/add/filename/for/tdl/scores/TDL Scores - 1Aug2018 PP - PK - Code 2.csv&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">WITH</span><span class="token plain"> CSV HEADER</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="combining-scores-and-discounts">Combining Scores and Discounts<a href="#combining-scores-and-discounts" class="hash-link" aria-label="Direct link to Combining Scores and Discounts" title="Direct link to Combining Scores and Discounts">​</a></h2><p>Now let&#x27;s combine the important parts of both data sources into one table, which we&#x27;ll begin to shape into a full set of TSPP data.</p><p>The following command will create and populate the table described above with the relevant, overlapping details from the table imported earlier with BVSes and the table with discount rates:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">CREATE TABLE tdl_scores_and_discounts AS</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  SELECT</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    s.market, s.origin, s.destination, s.cos, s.scac, s.bvs, dr.lh_rate, dr.sit_rate FROM temp_tdl_scores AS s</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  LEFT JOIN</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    temp_tsp_discount_rates as dr</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  ON</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    s.origin = dr.origin</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  AND</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    s.destination = dr.destination</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  AND</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    s.cos = dr.cos</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  AND</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    s.scac = dr.scac;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-column-to-hold-tdl-ids">Add column to hold TDL IDs<a href="#add-column-to-hold-tdl-ids" class="hash-link" aria-label="Direct link to Add column to hold TDL IDs" title="Direct link to Add column to hold TDL IDs">​</a></h3><p>Add a TDL ID column to fill with this next update:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> tdl_scores_and_discounts </span><span class="token keyword" style="color:#c5a5c5">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> tdl_id uuid</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Sometimes the data provided to us represents fields (destination, most recently) in different ways. Here&#x27;s how to alter the destination column to match other data sources (most notably the TDL table) - to change &#x27;REGION 1&#x27; to just &#x27;1&#x27; to make the next step work:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">UPDATE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tdl_scores_and_discounts</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">SET</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  destination = RIGHT(destination, char_length(destination) - 7);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Add TDL IDs to the rows in our interim table:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">UPDATE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tdl_scores_and_discounts as tsd</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">SET</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tdl_id = tdl.id</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  traffic_distribution_lists as tdl</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">WHERE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tdl.source_rate_area = tsd.origin</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">AND</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tdl.destination_region = tsd.destination</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">AND</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tdl.code_of_service = tsd.cos;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Check for null TDL IDs:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">count</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token keyword" style="color:#c5a5c5">DISTINCT</span><span class="token plain"> scac</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> tdl_scores_and_discounts </span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> tdl_id </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="if-tdl-id-is-still-null">If TDL ID is still null<a href="#if-tdl-id-is-still-null" class="hash-link" aria-label="Direct link to If TDL ID is still null" title="Direct link to If TDL ID is still null">​</a></h4><p>If count returns anything but 0, you&#x27;ll need to add new TDL entries.
Check for new entries on the
<a href="https://move.mil/sites/default/files/2019-01/2019%20Domestic%20Channel%20Control%20List.pdf" target="_blank" rel="noopener noreferrer">Domestic Channel Control List</a>.
They&#x27;ll be highlighted in red.
Create a new temp table for TDLs and add the new entries as follows:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> temp_tdls </span><span class="token keyword" style="color:#c5a5c5">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">*</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> traffic_distribution_lists</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> temp_tdls </span><span class="token keyword" style="color:#c5a5c5">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">boolean</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">INTO</span><span class="token plain"> temp_tdls </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> source_rate_area</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> destination_region</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> code_of_service</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> created_at</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> updated_at</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">import</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">VALUES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">uuid_generate_v4</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;US4965500&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;1&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;2&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">now</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">now</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">uuid_generate_v4</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;US4965500&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;1&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;D&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">now</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">now</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token comment" style="color:#999999">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">uuid_generate_v4</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;US4965500&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;10&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;2&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">now</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">now</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will add the new entries to the temporary TDL table,
forcing them to adhere to any table constraints
and generating new UUIDs to be consistent across environments.
For info on why having consistent UUIDs is important <a href="https://dp3.atlassian.net/l/c/1J6471UU" target="_blank" rel="noopener noreferrer">see this document</a></p><p>We&#x27;ll now <a href="/mymove-docs/docs/backend/setup/database-migrations#creating-migrations">create a new migration</a> with that data (replace your migration filename):</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token function" style="color:#79b6f2">make</span><span class="token plain"> bin/milmove</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">milmove gen migration -n add_new_tdls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token builtin class-name" style="color:#FAC863">echo</span><span class="token plain"> -e </span><span class="token string" style="color:#8dc891">&quot;INSERT INTO traffic_distribution_lists (id, source_rate_area, destination_region, code_of_service, created_at, updated_at) </span><span class="token string entity" style="color:#d7deea">\n</span><span class="token string" style="color:#8dc891">VALUES</span><span class="token string entity" style="color:#d7deea">\n</span><span class="token string" style="color:#8dc891">$(</span><br></span><span class="token-line" style="color:#ffffff"><span class="token string" style="color:#8dc891">./scripts/psql-dev &quot;</span><span class="token string entity" style="color:#d7deea">\c</span><span class="token string" style="color:#8dc891">opy (SELECT id, source_rate_area, destination_region, code_of_service FROM temp_tdls WHERE import = true) TO stdout WITH (FORMAT CSV, FORCE_QUOTE *, QUOTE &#x27;&#x27;&#x27;&#x27;);&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">awk</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;{print &quot;  (&quot;$0&quot;, now(), now()),&quot;}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">sed</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;$ s/.$//&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain">&quot; </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">&gt;</span><span class="token plain"> migrations/20190410152949_add_new_tdls.up.sql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will copy all rows from the table that were included in the new TDL import
and create an insert statement for the data.
You can also use <code>pg_dump</code> to generate this migration,
however replacing the timestamps with <code>now()</code> allows the environments
to have true <code>created_at</code> and <code>updated_at</code> timestamps.
Not your locally inserted time.</p><p>Once this migration is written, run it and rejoin the TDLs as above.</p><hr><h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-column-to-hold-tsp-ids">Add column to hold TSP IDs<a href="#add-column-to-hold-tsp-ids" class="hash-link" aria-label="Direct link to Add column to hold TSP IDs" title="Direct link to Add column to hold TSP IDs">​</a></h3><p>Make room for TSP IDs:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> tdl_scores_and_discounts </span><span class="token keyword" style="color:#c5a5c5">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> tsp_id uuid</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Import the TSP IDs:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">UPDATE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tdl_scores_and_discounts as tsd</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">SET</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tsp_id = tsp.id</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  transportation_service_providers tsp</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">WHERE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tsd.scac = tsp.standard_carrier_alpha_code;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similar to TDLs,
there may be missing TSPs.
Currently, we&#x27;re not using any of this TSP data for production moves,
but we have to satisfy the foreign key constraints for the TSPP data.</p><p>Check for missing TSP IDs:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">count</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token keyword" style="color:#c5a5c5">DISTINCT</span><span class="token plain"> scac</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> tdl_scores_and_discounts </span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> tsp_id </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="if-tsp-id-is-still-null">If TSP ID is still null<a href="#if-tsp-id-is-still-null" class="hash-link" aria-label="Direct link to If TSP ID is still null" title="Direct link to If TSP ID is still null">​</a></h4><p>Note we use GENERATED_UUID4_VAL here to represent a generated UUID, read <a href="/mymove-docs/docs/backend/setup/database-migrations#a-note-about-uuid_generate_v4">this doc</a> for details.
If this is not 0, add the TSPs:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> temp_tsps </span><span class="token keyword" style="color:#c5a5c5">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">*</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> transportation_service_providers</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TABLE</span><span class="token plain"> temp_tsps </span><span class="token keyword" style="color:#c5a5c5">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">COLUMN</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">boolean</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">INTO</span><span class="token plain"> temp_tsps </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">standard_carrier_alpha_code</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">import</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token keyword" style="color:#c5a5c5">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">DISTINCT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">scac</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> scac </span><span class="token keyword" style="color:#c5a5c5">AS</span><span class="token plain"> standard_carrier_alpha_code</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> GENERATED_UUID4_VAL </span><span class="token keyword" style="color:#c5a5c5">AS</span><span class="token plain"> id</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">true</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> tdl_scores_and_discounts</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> tsp_id </span><span class="token operator" style="color:#d7deea">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">NULL</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="/mymove-docs/docs/backend/setup/database-migrations#how-to-migrate-the-database">Generate the migration</a> (replacing your migration filename):</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token function" style="color:#79b6f2">make</span><span class="token plain"> bin/milmove</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">milmove gen migration -n add_new_scacs</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token builtin class-name" style="color:#FAC863">echo</span><span class="token plain"> -e </span><span class="token string" style="color:#8dc891">&quot;INSERT INTO transportation_service_providers (id, standard_carrier_alpha_code, created_at, updated_at) </span><span class="token string entity" style="color:#d7deea">\n</span><span class="token string" style="color:#8dc891">VALUES</span><span class="token string entity" style="color:#d7deea">\n</span><span class="token string" style="color:#8dc891">$(</span><br></span><span class="token-line" style="color:#ffffff"><span class="token string" style="color:#8dc891">./scripts/psql-dev &quot;</span><span class="token string entity" style="color:#d7deea">\c</span><span class="token string" style="color:#8dc891">opy (SELECT id, standard_carrier_alpha_code FROM temp_tsps WHERE import = true) TO stdout WITH (FORMAT CSV, FORCE_QUOTE *, QUOTE &#x27;&#x27;&#x27;&#x27;);&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">awk</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;{print &quot;  (&quot;$0&quot;, now(), now()),&quot;}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">sed</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;$ s/.$//&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain">&quot; </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">&gt;</span><span class="token plain"> migrations/20190409010258_add_new_scacs.up.sql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Run this migration and rejoin the TSP IDs as above.</p><hr><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generate-data-for-production-import">Generate data for production import<a href="#generate-data-for-production-import" class="hash-link" aria-label="Direct link to Generate data for production import" title="Direct link to Generate data for production import">​</a></h3><p>Now we&#x27;re ready to combine the datasets together into one table. First, be sure to clear out the <code>transportation_service_provider_performances</code> table in case it already contains data:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> transportation_service_provider_performances</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following command will fill the TSPP table with data. Use your data&#x27;s current rate cycle and performance period date in lieu of the hard-coded dates below.</p><blockquote><p><em>Rate cycle</em> in this context means the rate cycle <strong>period</strong>, so either the peak or non-peak part of the annual rate cycle and <strong>not</strong> the rate cycle itself.</p><p><a href="https://docs.google.com/document/d/12AN1igDt9Acxm9cu1cJA0fiWQIMI3XGs5u_jhCHLo6I" target="_blank" rel="noopener noreferrer">This document</a> specifies the date ranges for both the performance periods and the rate cycle periods.</p></blockquote><p>Note we use GENERATED_UUID4_VAL here to represent a generated UUID, read <a href="/mymove-docs/docs/backend/setup/database-migrations#a-note-about-uuid_generate_v4">this doc</a> for details.</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">INSERT INTO</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  transportation_service_provider_performances (id, performance_period_start, performance_period_end, traffic_distribution_list_id, offer_count, best_value_score, transportation_service_provider_id, created_at, updated_at, rate_cycle_start, rate_cycle_end, linehaul_rate, sit_rate)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  GENERATED_UUID4_VAL as id, &#x27;2018-08-01&#x27; as performance_period_start, &#x27;2018-09-30&#x27; as performance_period_end, tdl_id, 0 as offer_count, bvs, tsp_id, now() as created_at, now() as updated_at, &#x27;2018-05-15&#x27; as rate_cycle_start, &#x27;2018-09-30&#x27; as rate_cycle_end, lh_rate/100, sit_rate/100</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tdl_scores_and_discounts;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>/100</code> of the <code>sit_rate</code> and <code>linehaul_rate</code> columns accounts for the differences in representing percentages/decimals across sources. This changes integers into decimal representations that fit into our calculations of rates and reimbursements.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="export-tspp-data">Export TSPP Data<a href="#export-tspp-data" class="hash-link" aria-label="Direct link to Export TSPP Data" title="Direct link to Export TSPP Data">​</a></h3><p>Run this in your terminal to dump the contents of the <code>transportation_service_provider_performances</code> table for use elsewhere. Double-check your local db name before assuming this will work.</p><p><code>pg_dump -h localhost -U postgres -W dev_db --table transportation_service_provider_performances --data-only &gt; tspp_data_dump.pgsql</code></p><p>Et voilà: TSPPs!</p><p>Note that the above <code>pg_dump</code> command will generate a file that uses a single <code>COPY ... FROM stdin</code> to load data
as opposed to a series of <code>INSERT</code> statements.  Using <code>COPY</code> can be dramatically faster than <code>INSERT</code> -- around 100 times
faster in some cases.  We generally <a href="https://github.com/transcom/mymove/pull/2670/files#r322981353" target="_blank" rel="noopener noreferrer">prefer <code>INSERT</code></a>
but the amount of data being loaded may make using it simply too expensive for a migration.</p><p><strong>WARNING:</strong> If the generated file is larger than 250 MB then you will not be able to upload the file. This size limit is in place so that the anti-virus software can scan the file. In the case where a file has been generated that is larger than this size you&#x27;ll need to split the migration file into multiple migration files each with a size smaller than 250 MB.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-validation">Data Validation<a href="#data-validation" class="hash-link" aria-label="Direct link to Data Validation" title="Direct link to Data Validation">​</a></h2><p>The following SQL statements can be used to verify that the above process has been completed successfully. Some numbers may be slightly off
due to natural changes in the data, but any large discrepancies are a potential signal that something has gone wrong somewhere along the way.</p><p>NOTE: As of the updates for 2019-10-01 we only import the BVSes for the top performer, instead of everyone. This could lead to more variation in the numbers than in past updates. The numbers below have been updated to reflect the reduced imports.</p><p>NOTE 2: The first results below are what is expected after running the above import process. The subsequent results are from running the same verification queries after running all the migrations.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">/* returns total count of performances during import process this matches rows in csv */</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">dev_db=# SELECT COUNT(id) FROM transportation_service_provider_performances;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- import process result</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  count</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">---------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 847</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- result after running all migrations</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  count</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">---------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 19239</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- result after running all prod migrations</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  count</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">---------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 5989085</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">/* returns the lowest score and highest score */</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">dev_db=# select min(best_value_score), max(best_value_score) from transportation_service_provider_performances;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- import process result</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   min   |  max</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">---------+--------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  91.0   | 100.0</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- result after running all migrations</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   min   |  max</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">---------+--------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  50.0   | 100.0</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">/* returns the lowest score and highest sit rate */</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">dev_db=# select min(sit_rate), max(sit_rate) from transportation_service_provider_performances;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  min | max</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">------+------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 0.45 | 0.63</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">/* returns the lowest score and highest linehaul rate */</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">dev_db=# select min(linehaul_rate), max(linehaul_rate) from transportation_service_provider_performances;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> min | max</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-----+------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 0.4 | 0.68</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">/* returns the minimum and maximum number of areas a single tsp has won, so below means at min a tsp has 1, and at most a tsp has 511 */</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">dev_db=# SELECT min(count), max(count) FROM (</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    SELECT transportation_service_provider_id, COUNT(id) FROM transportation_service_provider_performances</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    GROUP BY transportation_service_provider_id</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    ) as tspp;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- import process result</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> min | max</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-----+------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   1 | 511</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- result after running all migrations</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> min | max</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-----+------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   1 | 2838</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- result after running all prod migrations</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> min | max</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-----+------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   2 | 8968</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">/* returns the total number of TSPs */</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">dev_db=# SELECT count(DISTINCT transportation_service_provider_id) FROM transportation_service_provider_performances;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- import process result</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   35</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- result after running all migrations</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  907</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- result after running all prod migrations</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  910</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">SELECT CONCAT(((bucket -1) * 100)::text, &#x27;-&#x27;, (bucket * 100)::text) as rows, count(transportation_service_provider_id) as tsps FROM (</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    SELECT transportation_service_provider_id, width_bucket(COUNT(id), 0, 2000, 20) as bucket FROM transportation_service_provider_performances</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    GROUP BY transportation_service_provider_id</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    ) as tspp</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   GROUP BY bucket;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- import process result</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   rows    | tsps</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-----------+-------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 0-100     |   33</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 200-300   |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 500-600   |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(3 rows)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- result after running all migrations</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   rows    | tsps</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-----------+-------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 0-100     |  898</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 100-200   |    3</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 200-300   |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 400-500   |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 300-400   |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 500-600   |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 1700-1800 |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 2000-2100 |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(8 rows)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- result after running all prod migrations</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">   rows    | tsps</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-----------+-------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 0-100     |   53</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 100-200   |    9</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 200-300   |   33</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 300-400   |   38</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 400-500   |    8</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 500-600   |    7</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 600-700   |    3</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 700-800   |    3</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 800-900   |    2</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 1100-1200 |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 1400-1500 |    1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 1500-1600 |    2</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"> 2000-2100 |  750</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(13 rows)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-- Spot check the data by picking a row from the TDL and TSP text/CSV files and verifying the data:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">SELECT source_rate_area, destination_region, code_of_service, performance_period_start, performance_period_end,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">       best_value_score, rate_cycle_start, rate_cycle_end, linehaul_rate, sit_rate, standard_carrier_alpha_code,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">       tdl.created_at</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">FROM traffic_distribution_lists AS tdl</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">LEFT JOIN transportation_service_provider_performances on tdl.id = transportation_service_provider_performances.traffic_distribution_list_id</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">LEFT JOIN transportation_service_providers on transportation_service_provider_performances.transportation_service_provider_id = transportation_service_providers.id</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">WHERE performance_period_start=&#x27;2019-10-01&#x27; and performance_period_end=&#x27;2019-12-31&#x27;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  AND destination_region=&#x27;1&#x27; AND source_rate_area=&#x27;US11&#x27;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  AND code_of_service=&#x27;D&#x27;;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="temp-data-clean-up">Temp Data Clean Up<a href="#temp-data-clean-up" class="hash-link" aria-label="Direct link to Temp Data Clean Up" title="Direct link to Temp Data Clean Up">​</a></h2><p>Vacuum up now that the party&#x27;s over. Only required if you haven&#x27;t reset the local database already.</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">DROP TABLE tdl_scores_and_discounts;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">DROP TABLE temp_tdl_scores;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">DROP TABLE temp_tsp_discount_rates;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-secure-migrations">Create Secure Migrations<a href="#create-secure-migrations" class="hash-link" aria-label="Direct link to Create Secure Migrations" title="Direct link to Create Secure Migrations">​</a></h2><p>You will have to create a secure migration for this data import. Two files will need to be created,
the file that contains the real data and a local secure migration (dummy file for dev). Follow the
<a href="/mymove-docs/docs/backend/setup/database-migrations#secure-migrations">secure migration steps</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-create-the-dummy-file">How to create the dummy file<a href="#how-to-create-the-dummy-file" class="hash-link" aria-label="Direct link to How to create the dummy file" title="Direct link to How to create the dummy file">​</a></h3><p>You will need to scrub the data that is in the dummy file. The fields: <code>linehaul_rate</code>, <code>sit_rate</code>, and <code>best_value_score</code>
are company competition sensitive data and needs to scrubbed.</p><p>The file will also need to be reduced. Currently, we are picking 2 TSPs per TDL.</p><p>We have a <a href="#">script</a> to help with this process. The script will backup the TSPP table, make the appropriate reduction of
data and scrubbing of key columns, output the results, then restore the original TSPP table.  You can run it like so:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">./scripts/export-obfuscated-tspp-sample &lt;filename&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Complete the <a href="/mymove-docs/docs/backend/setup/database-migrations#secure-migrations">secure migration steps</a> to
submit both migration files.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/transcom/mymove-docs/edit/main/docs/backend/guides/tspp-data-creation.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/mymove-docs/docs/backend/guides/golang-loops"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Loop Iteration in Golang</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/mymove-docs/docs/backend/guides/use-optimistic-locking"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">What Is Optimistic Locking?</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#verify-input-files" class="table-of-contents__link toc-highlight">Verify Input Files</a><ul><li><a href="#tdl-scores" class="table-of-contents__link toc-highlight">TDL Scores</a></li><li><a href="#tsp-rates" class="table-of-contents__link toc-highlight">TSP Rates</a></li><li><a href="#tdl-performance-dates-vs-tsp-rate-dates" class="table-of-contents__link toc-highlight">TDL Performance Dates vs TSP Rate Dates</a></li></ul></li><li><a href="#load-tsp-discount-rates" class="table-of-contents__link toc-highlight">Load TSP Discount Rates</a></li><li><a href="#load-tsp-best-value-scores-from-tdl-data" class="table-of-contents__link toc-highlight">Load TSP Best Value Scores from TDL data</a></li><li><a href="#combining-scores-and-discounts" class="table-of-contents__link toc-highlight">Combining Scores and Discounts</a><ul><li><a href="#add-column-to-hold-tdl-ids" class="table-of-contents__link toc-highlight">Add column to hold TDL IDs</a></li><li><a href="#add-column-to-hold-tsp-ids" class="table-of-contents__link toc-highlight">Add column to hold TSP IDs</a></li><li><a href="#generate-data-for-production-import" class="table-of-contents__link toc-highlight">Generate data for production import</a></li><li><a href="#export-tspp-data" class="table-of-contents__link toc-highlight">Export TSPP Data</a></li></ul></li><li><a href="#data-validation" class="table-of-contents__link toc-highlight">Data Validation</a></li><li><a href="#temp-data-clean-up" class="table-of-contents__link toc-highlight">Temp Data Clean Up</a></li><li><a href="#create-secure-migrations" class="table-of-contents__link toc-highlight">Create Secure Migrations</a><ul><li><a href="#how-to-create-the-dummy-file" class="table-of-contents__link toc-highlight">How to create the dummy file</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/about">About MilMove</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/adrs">Architecture Decision Records</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/frontend">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/backend">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/api">API</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/tools">Tools</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/transcom/mymove-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">MilMove Documentation GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="footer__link-item">MilMove GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://6130eb5cde15830007fdf57b--docusaurus-2.netlify.app/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2023  U.S. Federal Government (in countries where recognized) and TrussWorks. Built with Docusaurus.</div></div></div></footer></div>
<script src="/mymove-docs/assets/js/runtime~main.2d8cf14e.js"></script>
<script src="/mymove-docs/assets/js/main.72cd5155.js"></script>
</body>
</html>